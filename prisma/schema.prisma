generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  USER
  ADMIN
}

enum HouseholdType {
  PRIMARY // Family unit
  SECONDARY // Roommates, etc.
}

enum HouseholdRole {
  OWNER
  ADMIN
  ADULT
  TEEN
  CHILD
  TEMPORARY_GUEST
}

enum ConversationType {
  DIRECT
  GROUP
  CHANNEL
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  REACTION
}

enum ThreadType {
  MESSAGE
  TOPIC
  PROJECT
  DECISION
  DOCUMENTATION
}

enum ParticipantRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
  GUEST
}

enum BusinessRole {
  EMPLOYEE
  ADMIN
  MANAGER
}

enum InstitutionType {
  UNIVERSITY
  COLLEGE
  HIGH_SCHOOL
  ELEMENTARY_SCHOOL
}

enum InstitutionRole {
  STUDENT
  FACULTY
  STAFF
}

enum RelationshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

enum RelationshipType {
  REGULAR
  COLLEAGUE
}

enum ModuleStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ModuleCategory {
  PRODUCTIVITY
  COMMUNICATION
  ANALYTICS
  DEVELOPMENT
  ENTERTAINMENT
  EDUCATION
  FINANCE
  HEALTH
  OTHER
}

enum AIRequestStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
  EXECUTED
}

enum AIInteractionType {
  QUERY
  ACTION_REQUEST
  LEARNING
  FEEDBACK
  CORRECTION
}

enum CalendarType {
  LOCAL
  EXTERNAL
  RESOURCE
  SUBSCRIPTION
}

enum CalendarContextType {
  PERSONAL
  BUSINESS
  HOUSEHOLD
}

enum EventStatus {
  CONFIRMED
  TENTATIVE
  CANCELED
}

enum ReminderMethod {
  APP
  EMAIL
}

// ============================================================================
// MODULE SCHEMAS
// ============================================================================

// ============================================================================
// AUTH MODULE
// ============================================================================

// ============================================================================
// PROFILE PHOTOS - USER PHOTO LIBRARY
// ============================================================================
// Purpose: Store original profile photo uploads + derived avatar renditions
// Notes:
// - Original is immutable; avatarUrl can be regenerated (crop/rotate updates)
// - Trashed items integrate with Global Trash via trashedAt
// ============================================================================

model UserProfilePhoto {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional assignment back-relations (photo belongs to the user above; these link to user's current assignments)
  personalForUser User? @relation("UserPersonalPhoto")
  businessForUser User? @relation("UserBusinessPhoto")

  // Immutable original upload (source of truth)
  originalUrl String

  // Derived avatar rendition (square image used in UI)
  avatarUrl String

  // Crop metadata used to generate avatarUrl (stored for future edits/regeneration)
  crop     Json?
  rotation Int? // degrees

  trashedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId])
  @@index([trashedAt])
  @@map("user_profile_photos")
}

// ============================================================================
// AUTH MODULE
// ============================================================================

// ============================================================================
// USER & AUTHENTICATION MODELS
// ============================================================================

model User {
  id               String             @id @default(uuid())
  name             String?
  email            String             @unique
  password         String
  role             Role               @default(USER)
  emailVerified    DateTime?
  image            String?
  personalPhoto    String? // Personal profile photo
  businessPhoto    String? // Professional/business profile photo
  // Profile photo library + assignments (preferred; URLs above kept for backward compatibility)
  personalPhotoId  String?            @unique
  personalPhotoRef UserProfilePhoto?  @relation("UserPersonalPhoto", fields: [personalPhotoId], references: [id])
  businessPhotoId  String?            @unique
  businessPhotoRef UserProfilePhoto?  @relation("UserBusinessPhoto", fields: [businessPhotoId], references: [id])
  profilePhotos    UserProfilePhoto[]
  stripeCustomerId String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  // User Numbering System
  userNumber         String?   @unique // e.g., "1-06-201-00023"
  country            Country?  @relation(fields: [countryId], references: [id])
  countryId          String?
  region             Region?   @relation(fields: [regionId], references: [id])
  regionId           String?
  town               Town?     @relation(fields: [townId], references: [id])
  townId             String?
  locationDetectedAt DateTime? // Track when location was detected
  locationUpdatedAt  DateTime? // Track manual location updates

  // Billing and Subscription relationships
  subscriptions       Subscription[]
  moduleSubscriptions ModuleSubscription[]
  usageRecords        UsageRecord[]
  invoices            Invoice[]
  developerRevenue    DeveloperRevenue[]
  pricingConfigs      PricingConfig[]      @relation("PricingConfigCreatedBy")
  priceChanges        PriceChange[]        @relation("PriceChangeCreatedBy")
  aiQueryBalances     AIQueryBalance[]
  aiQueryPurchases    AIQueryPurchase[]

  // Existing relationships
  messages   Message[]
  files      File[]
  businesses BusinessMember[]
  modules    Module[]         @relation("ModuleDeveloper") // Modules developed by this user

  // Missing relation fields
  notifications            Notification[]
  pushSubscriptions        PushSubscription[]
  userPreferences          UserPreference[]
  dashboards               Dashboard[]
  auditLogs                AuditLog[]
  userConsents             UserConsent[]
  dataDeletionRequests     DataDeletionRequest[]
  userPrivacySettings      UserPrivacySettings?
  folders                  Folder[]
  filePermissions          FilePermission[]
  folderPermissions        FolderPermission[]
  activities               Activity[]
  refreshTokens            RefreshToken[]
  passwordResetTokens      PasswordResetToken[]
  emailVerificationTokens  EmailVerificationToken[]
  messageReactions         MessageReaction[]
  readReceipts             ReadReceipt[]
  conversationParticipants ConversationParticipant[]
  threadParticipants       ThreadParticipant[]
  businessInvitations      BusinessInvitation[]      @relation("BusinessInvitationInvitedBy")
  institutionMembers       InstitutionMember[]
  institutionInvitations   InstitutionInvitation[]   @relation("InstitutionInvitationInvitedBy")
  relationshipsSent        Relationship[]            @relation("RelationshipSender")
  relationshipsReceived    Relationship[]            @relation("RelationshipReceiver")
  businessFollows          BusinessFollow[]
  moduleInstallations      ModuleInstallation[]      @relation("ModuleUser")
  moduleSubmissions        ModuleSubmission[]        @relation("ModuleSubmitter")
  moduleSubmissionReviews  ModuleSubmission[]        @relation("ModuleSubmissionReviewer")
  moduleReviews            ModuleReview[]            @relation("ModuleReviewer")
  householdMembers         HouseholdMember[]
  aiPersonalityProfiles    AIPersonalityProfile[]
  aiAutonomySettings       AIAutonomySettings[]
  aiApprovalRequests       AIApprovalRequest[]
  aiConversationHistories  AIConversationHistory[]
  aiUsageTrackings         AIUsageTracking[]
  aiLearningEvents         AILearningEvent[]
  aiContextCache           UserAIContextCache?
  aiConversations          AIConversation[]
  userAIContexts           UserAIContext[]

  // Calendar relations
  calendarMemberships CalendarMember[]
  // Calendar event comments
  eventComments       EventComment[]

  // Admin portal relations
  contentReports    ContentReport[]      @relation("ContentReporter")
  impersonatedUsers AdminImpersonation[] @relation("ImpersonatedUser")
  impersonatedBy    AdminImpersonation[] @relation("AdminImpersonator")

  // HR attendance exception relations
  attendanceExceptionsDetected AttendanceException[] @relation("AttendanceExceptionDetectedBy")
  attendanceExceptionsResolved AttendanceException[] @relation("AttendanceExceptionResolvedBy")

  // Support system relations
  supportTickets          SupportTicket[] // Tickets created by this user
  assignedTickets         SupportTicket[]        @relation("AssignedTickets") // Tickets assigned to this user (if admin/agent)
  supportMessages         SupportMessage[] // Messages sent by this user
  knowledgeBaseArticles   KnowledgeBaseArticle[] // Articles created by this user
  liveChatSessions        LiveChatSession[] // Chat sessions for this user
  liveChatSessionsAsAgent LiveChatSession[]      @relation("LiveChatSessions") // Chat sessions where user is agent
  liveChatMessages        LiveChatMessage[] // Chat messages sent by this user

  // Org Chart & Permission System relations
  employeePositions                 EmployeePosition[]
  assignedEmployeePositions         EmployeePosition[]           @relation("EmployeePositionAssignedBy")
  permissionManagementRights        PermissionManagementRights[]
  grantedPermissionManagementRights PermissionManagementRights[] @relation("PermissionManagementRightsGrantedBy")
  permissionChanges                 PermissionChange[]

  // Business Front Page Customization
  frontPageCustomizations UserFrontPageCustomization[]

  // Scheduling Module relations
  schedulesPublished      Schedule[]         @relation("SchedulePublishedBy")
  schedulesCreated        Schedule[]         @relation("ScheduleCreatedBy")
  shiftSwapRequestsFrom   ShiftSwapRequest[] @relation("SwapRequestedBy")
  shiftSwapRequestsTo     ShiftSwapRequest[] @relation("SwapRequestedTo")
  shiftSwapApprovalsGiven ShiftSwapRequest[] @relation("SwapApprovedBy")

  // Todo Module relations
  createdTasks  Task[]        @relation("TaskCreator")
  assignedTasks Task[]        @relation("TaskAssignee")
  taskComments  TaskComment[]
  taskWatchers  TaskWatcher[]
  taskTimeLogs  TaskTimeLog[]

  @@index([userNumber])
  @@index([countryId, regionId, townId])
  @@map("users")
}

model Notification {
  id           String                 @id @default(uuid())
  user         User                   @relation(fields: [userId], references: [id])
  userId       String
  type         String
  title        String
  body         String?
  data         Json?
  read         Boolean                @default(false)
  priority     String? // 'low' | 'normal' | 'high' | 'urgent'
  snoozedUntil DateTime?
  createdAt    DateTime               @default(now())
  deliveredAt  DateTime?
  deleted      Boolean                @default(false)
  deliveries   NotificationDelivery[]
}

model NotificationDelivery {
  id             String       @id @default(uuid())
  notification   Notification @relation(fields: [notificationId], references: [id])
  notificationId String
  channel        String // e.g., 'in-app', 'email', 'push'
  deliveredAt    DateTime?
  status         String // e.g., 'pending', 'delivered', 'failed'
}

model PushSubscription {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, endpoint])
}

model UserPreference {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  key       String
  value     String
  updatedAt DateTime @updatedAt

  @@unique([userId, key])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// User consent and privacy management
model UserConsent {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  consentType String // 'TERMS_OF_SERVICE', 'PRIVACY_POLICY', 'DATA_PROCESSING', 'MARKETING', 'COLLECTIVE_AI_LEARNING'
  version     String // Version of the consent document
  granted     Boolean   @default(false)
  grantedAt   DateTime?
  revokedAt   DateTime?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([userId, consentType, version])
  @@index([userId])
  @@index([consentType])
  @@map("user_consents")
}

// Data deletion requests (GDPR right to be forgotten)
model DataDeletionRequest {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  status      String    @default("PENDING") // 'PENDING', 'PROCESSING', 'COMPLETED', 'CANCELLED'
  reason      String? // Optional reason for deletion
  requestedAt DateTime  @default(now())
  processedAt DateTime?
  completedAt DateTime?
  notes       String? // Admin notes
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@map("data_deletion_requests")
}

// User privacy settings
model UserPrivacySettings {
  id                      String   @id @default(uuid())
  userId                  String   @unique
  user                    User     @relation(fields: [userId], references: [id])
  profileVisibility       String   @default("PUBLIC") // 'PUBLIC', 'PRIVATE', 'BUSINESS_ONLY'
  activityVisibility      String   @default("PUBLIC") // 'PUBLIC', 'PRIVATE', 'BUSINESS_ONLY'
  allowDataProcessing     Boolean  @default(true)
  allowMarketingEmails    Boolean  @default(false)
  allowAnalytics          Boolean  @default(true)
  allowAuditLogs          Boolean  @default(true)
  allowCollectiveLearning Boolean  @default(false) // Consent for centralized AI learning
  dataRetentionPeriod     Int      @default(2555) // Days (7 years default)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@map("user_privacy_settings")
}

// Location Models for User Numbering System
model Country {
  id        String   @id @default(uuid())
  name      String
  phoneCode String   @unique // e.g., "1", "44", "33"
  regions   Region[]
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("countries")
}

model Region {
  id        String   @id @default(uuid())
  name      String
  code      String // 3-digit code, e.g., "001", "002"
  country   Country  @relation(fields: [countryId], references: [id])
  countryId String
  towns     Town[]
  users     User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([countryId, code])
  @@map("regions")
}

model Town {
  id          String       @id @default(uuid())
  name        String
  code        String // 3-digit code, e.g., "001", "002"
  region      Region       @relation(fields: [regionId], references: [id])
  regionId    String
  users       User[]
  userSerials UserSerial[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([regionId, code])
  @@map("towns")
}

model UserSerial {
  id         String   @id @default(uuid())
  town       Town     @relation(fields: [townId], references: [id])
  townId     String
  lastSerial Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@unique([townId])
  @@map("user_serials")
}

// ============================================================================
// CHAT MODULE
// ============================================================================

// ============================================================================
// CHAT & COMMUNICATION MODELS
// ============================================================================

model Conversation {
  id            String                    @id @default(uuid())
  name          String?
  type          ConversationType          @default(DIRECT)
  dashboard     Dashboard?                @relation(fields: [dashboardId], references: [id])
  dashboardId   String?
  participants  ConversationParticipant[]
  messages      Message[]
  threads       Thread[]
  trashedAt     DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  lastMessageAt DateTime?

  @@index([lastMessageAt])
  @@index([type])
  @@index([dashboardId])
  @@map("conversations")
}

model ConversationParticipant {
  id             String          @id @default(uuid())
  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  role           ParticipantRole @default(MEMBER)
  joinedAt       DateTime        @default(now())
  leftAt         DateTime?
  isActive       Boolean         @default(true)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id             String            @id @default(uuid())
  conversation   Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  sender         User              @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId       String
  content        String
  type           MessageType       @default(TEXT)
  fileReferences FileReference[]
  reactions      MessageReaction[]
  readReceipts   ReadReceipt[]
  thread         Thread?           @relation(fields: [threadId], references: [id])
  threadId       String?
  replyTo        Message?          @relation("MessageReplies", fields: [replyToId], references: [id])
  replyToId      String?
  replies        Message[]         @relation("MessageReplies")
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  editedAt       DateTime?
  deletedAt      DateTime?

  @@index([conversationId])
  @@index([senderId])
  @@index([threadId])
  @@index([createdAt])
  @@map("messages")
}

model FileReference {
  id        String   @id @default(uuid())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  file      File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  fileId    String
  createdAt DateTime @default(now())

  @@unique([messageId, fileId])
  @@index([messageId])
  @@index([fileId])
  @@map("file_references")
}

model MessageReaction {
  id        String   @id @default(uuid())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  emoji     String
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("message_reactions")
}

model ReadReceipt {
  id        String   @id @default(uuid())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  readAt    DateTime @default(now())

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@map("read_receipts")
}

model Thread {
  id             String              @id @default(uuid())
  conversation   Conversation        @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  name           String?
  type           ThreadType          @default(MESSAGE)
  messages       Message[]
  participants   ThreadParticipant[]
  parent         Thread?             @relation("ThreadParent", fields: [parentId], references: [id])
  parentId       String?
  children       Thread[]            @relation("ThreadParent")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  lastMessageAt  DateTime?

  @@index([conversationId])
  @@index([parentId])
  @@index([type])
  @@map("threads")
}

model ThreadParticipant {
  id       String          @id @default(uuid())
  thread   Thread          @relation(fields: [threadId], references: [id], onDelete: Cascade)
  threadId String
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String
  role     ParticipantRole @default(MEMBER)
  joinedAt DateTime        @default(now())
  leftAt   DateTime?
  isActive Boolean         @default(true)

  @@unique([threadId, userId])
  @@index([threadId])
  @@index([userId])
  @@map("thread_participants")
}

// ============================================================================
// BUSINESS MODULE
// ============================================================================

// ============================================================================
// BUSINESS & ENTERPRISE MODELS
// ============================================================================

model Business {
  id                          String                       @id @default(uuid())
  name                        String
  ein                         String                       @unique // Employer Identification Number (US) or equivalent
  einVerified                 Boolean                      @default(false)
  industry                    String?
  size                        String? // e.g., "1-10", "11-50", "51-200", "200+"
  website                     String?
  address                     Json? // Structured address data
  phone                       String?
  email                       String?
  logo                        String? // URL to logo image
  description                 String?
  branding                    Json? // Business branding configuration (colors, fonts, etc.)
  // Billing fields
  tier                        String                       @default("free") // 'free', 'standard', 'enterprise'
  billingEmail                String?
  billingAddress              Json?
  taxId                       String?
  stripeCustomerId            String?
  // Relationships
  dashboards                  Dashboard[]
  members                     BusinessMember[]
  invitations                 BusinessInvitation[]
  departments                 Department[]
  jobs                        Job[]
  ssoConfigs                  SSOConfig[]
  modules                     Module[]
  subscriptions               Subscription[]
  moduleSubscriptions         ModuleSubscription[]
  usageRecords                UsageRecord[]
  invoices                    Invoice[]
  aiQueryBalances             AIQueryBalance[]
  aiQueryPurchases            AIQueryPurchase[]
  aiConversations             AIConversation[]
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  businessFollows             BusinessFollow[]
  businessModuleInstallations BusinessModuleInstallation[]
  businessModuleSubscriptions BusinessModuleSubscription[]
  // Org Chart & Permission System
  organizationalTiers         OrganizationalTier[]
  positions                   Position[]
  permissionSets              PermissionSet[]
  employeePositions           EmployeePosition[]
  permissionChanges           PermissionChange[]
  permissionManagementRights  PermissionManagementRights[]
  // Enterprise AI Digital Twin
  aiDigitalTwin               BusinessAIDigitalTwin?
  aiSettings                  Json? // Business-wide AI preferences and configuration
  // Business Front Page Configuration
  frontPageConfig             BusinessFrontPageConfig?
  userFrontPageCustomizations UserFrontPageCustomization[]
  // HR Module
  employeeHRProfiles          EmployeeHRProfile[]
  managerApprovalHierarchies  ManagerApprovalHierarchy[]
  hrModuleSettings            HRModuleSettings?
  timeOffRequests             TimeOffRequest[]             @relation("BusinessTimeOffRequests")
  adminImpersonations         AdminImpersonation[]
  attendancePolicies          AttendancePolicy[]
  attendanceShiftTemplates    AttendanceShiftTemplate[]
  attendanceShiftAssignments  AttendanceShiftAssignment[]
  attendanceRecords           AttendanceRecord[]
  attendanceExceptions        AttendanceException[]
  onboardingTemplates         OnboardingTemplate[]         @relation("BusinessOnboardingTemplates")
  onboardingTaskTemplates     OnboardingTaskTemplate[]     @relation("BusinessOnboardingTaskTemplates")
  employeeOnboardingJourneys  EmployeeOnboardingJourney[]  @relation("BusinessEmployeeOnboardingJourneys")
  employeeOnboardingTasks     EmployeeOnboardingTask[]     @relation("BusinessEmployeeOnboardingTasks")
  // Scheduling Module
  schedules                   Schedule[]                   @relation("BusinessSchedules")
  scheduleShifts              ScheduleShift[]              @relation("BusinessScheduleShifts")
  shiftTemplates              ShiftTemplate[]              @relation("BusinessShiftTemplates")
  employeeAvailability        EmployeeAvailability[]       @relation("BusinessEmployeeAvailability")
  shiftSwapRequests           ShiftSwapRequest[]           @relation("BusinessShiftSwapRequests")
  scheduleTemplates           ScheduleTemplate[]           @relation("BusinessScheduleTemplates")
  businessStations            BusinessStation[]            @relation("BusinessStations")
  jobLocations                JobLocation[]                @relation("BusinessJobLocations")

  // Scheduling Configuration
  schedulingMode     SchedulingMode?
  schedulingStrategy SchedulingStrategy?
  schedulingConfig   Json? // { 
  //   layout: 'employee' | 'role' | 'station',
  //   viewPreference: 'weekly' | 'two_weeks' | 'monthly',
  //   weekStartDay: 'monday' | 'sunday',
  //   defaultScheduleDuration: number (days: 7, 14, 30),
  //   defaultTimezone: string (e.g., 'America/New_York')
  // }

  @@index([ein])
  @@index([schedulingMode])
  @@map("businesses")
}

// ============================================================================
// SCHEDULING ENUMS
// ============================================================================

enum SchedulingMode {
  RESTAURANT
  HEALTHCARE
  RETAIL
  MANUFACTURING
  OFFICE
  COFFEE_SHOP
  OTHER
}

enum SchedulingStrategy {
  AVAILABILITY_FIRST
  BUDGET_FIRST
  COMPLIANCE_FIRST
  TEMPLATE_BASED
  AUTO_GENERATE
}

model Department {
  id                    String       @id @default(uuid())
  business              Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId            String
  name                  String
  description           String?
  parentDepartmentId    String? // For nested departments
  parentDepartment      Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id])
  childDepartments      Department[] @relation("DepartmentHierarchy")
  headPositionId        String? // VP or Director role
  headPosition          Position?    @relation("DepartmentHead", fields: [headPositionId], references: [id])
  departmentModules     Json? // Modules specific to this department
  departmentPermissions Json? // Default permissions for department
  positions             Position[]
  jobs                  Job[]
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@unique([businessId, name])
  @@index([businessId])
  @@index([parentDepartmentId])
  @@index([headPositionId])
  @@map("departments")
}

model Job {
  id           String           @id @default(uuid())
  business     Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId   String
  department   Department?      @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId String?
  title        String
  description  String?
  permissions  Json? // Module permissions for this job
  members      BusinessMember[]
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([businessId, title])
  @@index([businessId])
  @@index([departmentId])
  @@map("jobs")
}

model SSOConfig {
  id         String   @id @default(uuid())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String
  provider   String // e.g., 'google', 'azure', 'okta', 'saml'
  name       String // Display name for the SSO provider
  config     Json // Provider-specific configuration
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([businessId, provider])
  @@index([businessId])
  @@map("sso_configs")
}

model BusinessMember {
  id         String       @id @default(uuid())
  business   Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  role       BusinessRole @default(EMPLOYEE)
  title      String? // Job title
  department String? // Department/team
  job        Job?         @relation(fields: [jobId], references: [id], onDelete: SetNull)
  jobId      String?
  joinedAt   DateTime     @default(now())
  leftAt     DateTime?
  isActive   Boolean      @default(true)
  // Permissions
  canInvite  Boolean      @default(false)
  canManage  Boolean      @default(false)
  canBilling Boolean      @default(false)

  @@unique([businessId, userId])
  @@index([businessId])
  @@index([userId])
  @@index([jobId])
  @@map("business_members")
}

model BusinessInvitation {
  id          String       @id @default(uuid())
  business    Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId  String
  email       String
  role        BusinessRole @default(EMPLOYEE)
  title       String? // Job title
  department  String? // Department/team
  invitedBy   User         @relation("BusinessInvitationInvitedBy", fields: [invitedById], references: [id])
  invitedById String
  token       String       @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime     @default(now())

  @@index([businessId])
  @@index([email])
  @@index([token])
  @@map("business_invitations")
}

model EducationalInstitution {
  id          String                  @id @default(uuid())
  name        String
  type        InstitutionType         @default(UNIVERSITY)
  country     String
  state       String?
  city        String?
  website     String?
  email       String?
  phone       String?
  logo        String? // URL to logo image
  description String?
  // Relationships
  dashboards  Dashboard[]
  members     InstitutionMember[]
  invitations InstitutionInvitation[]
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@map("educational_institutions")
}

model InstitutionMember {
  id            String                 @id @default(uuid())
  institution   EducationalInstitution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId String
  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  role          InstitutionRole        @default(STUDENT)
  title         String? // Student ID, faculty position, etc.
  department    String? // Major, department, school
  joinedAt      DateTime               @default(now())
  leftAt        DateTime?
  isActive      Boolean                @default(true)
  // Permissions
  canInvite     Boolean                @default(false)
  canManage     Boolean                @default(false)

  @@unique([institutionId, userId])
  @@index([institutionId])
  @@index([userId])
  @@map("institution_members")
}

model InstitutionInvitation {
  id            String                 @id @default(uuid())
  institution   EducationalInstitution @relation(fields: [institutionId], references: [id], onDelete: Cascade)
  institutionId String
  email         String
  role          InstitutionRole        @default(STUDENT)
  title         String? // Student ID, faculty position, etc.
  department    String? // Major, department, school
  invitedBy     User                   @relation("InstitutionInvitationInvitedBy", fields: [invitedById], references: [id])
  invitedById   String
  token         String                 @unique
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime               @default(now())

  @@index([institutionId])
  @@index([email])
  @@index([token])
  @@map("institution_invitations")
}

// Personal relationship models and enums
model Relationship {
  id             String             @id @default(uuid())
  sender         User               @relation("RelationshipSender", fields: [senderId], references: [id], onDelete: Cascade)
  senderId       String
  receiver       User               @relation("RelationshipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  receiverId     String
  status         RelationshipStatus @default(PENDING)
  type           RelationshipType   @default(REGULAR)
  // Organization context for colleague relationships
  organizationId String? // Optional: for colleague relationships
  message        String? // Optional message with connection request
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([organizationId])
  @@map("relationships")
}

model BusinessFollow {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String
  createdAt  DateTime @default(now())

  @@unique([userId, businessId])
  @@index([businessId])
  @@index([userId])
  @@map("business_follows")
}

// ============================================================================
// BUSINESS MODULE
// ============================================================================

// ============================================================================
// DASHBOARD & WIDGET MODELS
// ============================================================================

model Dashboard {
  id                 String                  @id @default(uuid())
  user               User                    @relation(fields: [userId], references: [id])
  userId             String
  name               String
  layout             Json? // Stores widget positions, layout state
  preferences        Json? // User-specific dashboard preferences
  retentionPolicy    RetentionPolicy?
  complianceSettings ComplianceSettings?
  widgets            Widget[]
  conversations      Conversation[]
  aiConversations    AIConversation[]
  files              File[]
  folders            Folder[]
  trashedAt          DateTime?
  // Business, Educational, and Household contexts
  business           Business?               @relation(fields: [businessId], references: [id])
  businessId         String?
  institution        EducationalInstitution? @relation(fields: [institutionId], references: [id])
  institutionId      String?
  household          Household?              @relation(fields: [householdId], references: [id])
  householdId        String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  @@index([businessId])
  @@index([institutionId])
  @@index([householdId])
  @@map("dashboards")
}

model RetentionPolicy {
  id                   String    @id @default(uuid())
  dashboard            Dashboard @relation(fields: [dashboardId], references: [id])
  dashboardId          String    @unique
  messageRetentionDays Int       @default(365)
  autoDeleteEnabled    Boolean   @default(false)
  fileRetentionDays    Int       @default(730)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

model ComplianceSettings {
  id                  String    @id @default(uuid())
  dashboard           Dashboard @relation(fields: [dashboardId], references: [id])
  dashboardId         String    @unique
  complianceMode      String    @default("standard") // standard, strict, custom
  encryptionEnabled   Boolean   @default(false)
  auditLoggingEnabled Boolean   @default(true)
  dataResidency       String? // e.g., "US", "EU", "APAC"
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model Widget {
  id          String    @id @default(uuid())
  dashboard   Dashboard @relation(fields: [dashboardId], references: [id])
  dashboardId String
  type        String // e.g., 'chat', 'drive', 'analytics', etc.
  config      Json? // Widget-specific config (e.g., filters, settings)
  position    Json? // Position/size in dashboard layout
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ============================================================================
// BUSINESS MODULE
// ============================================================================

// ============================================================================
// BUSINESS FRONT PAGE CONFIGURATION MODELS
// ============================================================================

model BusinessFrontPageConfig {
  id         String   @id @default(uuid())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String   @unique

  // Layout Configuration
  layout Json? // Grid layout settings, widget positions, sizes
  theme  Json? // Colors, fonts, spacing overrides specific to front page

  // Feature Toggles - Control which sections appear
  showAIAssistant    Boolean @default(true)
  showCompanyStats   Boolean @default(true)
  showPersonalStats  Boolean @default(true)
  showRecentActivity Boolean @default(true)
  showQuickActions   Boolean @default(true)
  showAnnouncements  Boolean @default(true)
  showUpcomingEvents Boolean @default(true)
  showTeamHighlights Boolean @default(false)
  showMetrics        Boolean @default(true)
  showTasks          Boolean @default(true)

  // Content Customization
  welcomeMessage       String? // Custom welcome message (supports markdown)
  heroImage            String? // Hero banner image URL
  companyAnnouncements Json? // Array of announcement objects
  quickLinks           Json? // Array of quick link objects

  // User Customization Settings
  allowUserCustomization  Boolean @default(false) // Can employees customize their view?
  userCustomizableWidgets Json? // Array of widget IDs that users can move/hide

  // Widgets
  widgets BusinessFrontWidget[]

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created the config
  updatedBy String? // User ID who last updated

  @@map("business_front_page_configs")
}

model BusinessFrontWidget {
  id       String                  @id @default(uuid())
  config   BusinessFrontPageConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  configId String

  // Widget Identification
  widgetType  String // 'ai-assistant', 'company-stats', 'personal-stats', 'announcements', 'quick-actions', 'calendar', 'recent-activity', 'team-highlights', 'tasks', 'metrics', 'custom'
  title       String // Display title
  description String? // Optional description

  // Layout
  position Json // { x: number, y: number, width: number, height: number }
  visible  Boolean @default(true)
  order    Int     @default(0)

  // Widget-Specific Settings
  settings Json? // Widget-specific configuration (chart types, data sources, refresh rates, etc.)

  // Permission Integration (Using Org Chart System)
  requiredPermission   String? // References existing Permission (format: "moduleId.featureId.action")
  visibleToRoles       Json? // Array of BusinessRole enum values ['ADMIN', 'MANAGER', 'EMPLOYEE']
  visibleToTiers       Json? // Array of OrganizationalTier IDs
  visibleToPositions   Json? // Array of Position IDs
  visibleToDepartments Json? // Array of Department IDs

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([configId])
  @@index([widgetType])
  @@index([visible])
  @@map("business_front_widgets")
}

model UserFrontPageCustomization {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String

  // User Customizations (only if allowed by business)
  hiddenWidgets   Json? // Array of widget IDs the user has hidden
  widgetPositions Json? // Custom widget positions if user customization is allowed
  customSettings  Json? // User-specific preferences (theme overrides, refresh rates, etc.)

  // Preferences
  preferredView String @default("default") // 'default', 'compact', 'expanded'

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@map("user_front_page_customizations")
}

// ============================================================================
// BUSINESS MODULE
// ============================================================================

// ============================================================================
// HOUSEHOLD MANAGEMENT MODELS
// ============================================================================

model Household {
  id          String        @id @default(uuid())
  name        String
  description String?
  type        HouseholdType
  isPrimary   Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relationships
  members    HouseholdMember[]
  dashboards Dashboard[]

  @@map("households")
}

model HouseholdMember {
  id          String        @id @default(uuid())
  userId      String
  householdId String
  role        HouseholdRole
  joinedAt    DateTime      @default(now())
  expiresAt   DateTime? // For temporary guests
  isActive    Boolean       @default(true)

  // Relationships
  user      User      @relation(fields: [userId], references: [id])
  household Household @relation(fields: [householdId], references: [id])

  @@unique([userId, householdId])
  @@index([userId])
  @@index([householdId])
  @@map("household_members")
}

// ============================================================================
// BUSINESS MODULE
// ============================================================================

// ============================================================================
// MODULE & MARKETPLACE MODELS
// ============================================================================

model Module {
  id                    String         @id @default(uuid())
  name                  String
  description           String
  version               String
  category              ModuleCategory
  tags                  String[]
  icon                  String?
  screenshots           String[]
  developer             User           @relation("ModuleDeveloper", fields: [developerId], references: [id])
  developerId           String
  business              Business?      @relation(fields: [businessId], references: [id])
  businessId            String?
  status                ModuleStatus   @default(PENDING)
  downloads             Int            @default(0)
  rating                Float          @default(0)
  reviewCount           Int            @default(0)
  manifest              Json // Module manifest with configuration
  dependencies          String[] // List of required modules
  permissions           String[] // Required permissions
  // Billing fields
  pricingTier           String         @default("free") // 'free', 'premium', 'enterprise'
  basePrice             Float          @default(0)
  enterprisePrice       Float          @default(0)
  isProprietary         Boolean        @default(false)
  revenueSplit          Float          @default(0.7) // 0.7 = 70% to developer (legacy, use RevenueSplitService)
  // Apple-style revenue split tracking
  totalLifetimeRevenue  Float          @default(0) // Total revenue for small business eligibility
  smallBusinessEligible Boolean        @default(false) // Eligible for 15% commission (<$1M lifetime)
  // Stripe fields
  stripeProductId       String?
  stripePriceId         String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  installations         ModuleInstallation[]
  submissions           ModuleSubmission[]
  moduleReviews         ModuleReview[]
  subscriptions         ModuleSubscription[]
  developerRevenue      DeveloperRevenue[]
  businessInstallations BusinessModuleInstallation[]
  businessSubscriptions BusinessModuleSubscription[]
  aiContextRegistry     ModuleAIContextRegistry?
  aiPerformanceMetrics  ModuleAIPerformanceMetric[]

  @@index([developerId])
  @@index([businessId])
  @@index([status])
  @@index([category])
  @@map("modules")
}

model ModuleInstallation {
  id          String   @id @default(uuid())
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId    String
  user        User     @relation("ModuleUser", fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  installedAt DateTime @default(now())
  configured  Json? // Module-specific configuration
  enabled     Boolean  @default(true)

  // AI context caching
  cachedContext   Json? // Cached AI context data
  contextCachedAt DateTime? // When context was last cached

  @@unique([moduleId, userId])
  @@index([moduleId])
  @@index([userId])
  @@map("module_installations")
}

// Business-scoped module installations (enterprise scope)
model BusinessModuleInstallation {
  id          String   @id @default(uuid())
  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId    String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId  String
  installedBy String? // User who installed the module
  installedAt DateTime @default(now())
  configured  Json?
  enabled     Boolean  @default(true)

  @@unique([moduleId, businessId])
  @@index([moduleId])
  @@index([businessId])
  @@map("business_module_installations")
}

// Business module subscriptions for paid modules
model BusinessModuleSubscription {
  id                   String   @id @default(uuid())
  module               Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId             String
  business             Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId           String
  tier                 String // 'premium', 'enterprise'
  amount               Float
  status               String // 'active', 'cancelled', 'past_due', 'unpaid'
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([moduleId, businessId])
  @@index([moduleId])
  @@index([businessId])
  @@map("business_module_subscriptions")
}

model ModuleSubmission {
  id          String       @id @default(uuid())
  module      Module       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId    String
  submitter   User         @relation("ModuleSubmitter", fields: [submitterId], references: [id])
  submitterId String
  reviewer    User?        @relation("ModuleSubmissionReviewer", fields: [reviewerId], references: [id])
  reviewerId  String?
  status      ModuleStatus @default(PENDING)
  reviewNotes String?
  submittedAt DateTime     @default(now())
  reviewedAt  DateTime?

  @@index([moduleId])
  @@index([submitterId])
  @@index([reviewerId])
  @@index([status])
  @@map("module_submissions")
}

model ModuleReview {
  id         String   @id @default(uuid())
  module     Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  moduleId   String
  reviewer   User     @relation("ModuleReviewer", fields: [reviewerId], references: [id])
  reviewerId String
  rating     Int // 1-5 stars
  comment    String?
  createdAt  DateTime @default(now())

  @@unique([moduleId, reviewerId])
  @@index([moduleId])
  @@index([reviewerId])
  @@map("module_reviews")
}

// ============================================================================
// BUSINESS MODULE
// ============================================================================

// ============================================================================
// ORG CHART & PERMISSION SYSTEM MODELS
// ============================================================================

model OrganizationalTier {
  id                 String     @id @default(uuid())
  business           Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId         String
  name               String // "C-Suite", "VP Level", "Director", "Manager", "Employee"
  level              Int // 1 = highest, 5 = lowest
  description        String?
  defaultPermissions Json? // Default permission set for this tier
  defaultModules     Json? // Default modules for this tier
  positions          Position[]
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@unique([businessId, name])
  @@index([businessId])
  @@index([level])
  @@map("organizational_tiers")
}

model Position {
  id                String             @id @default(uuid())
  business          Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId        String
  title             String
  tier              OrganizationalTier @relation(fields: [tierId], references: [id])
  tierId            String
  department        Department?        @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId      String?
  reportsTo         Position?          @relation("PositionHierarchy", fields: [reportsToId], references: [id])
  reportsToId       String?
  directReports     Position[]         @relation("PositionHierarchy")
  headOfDepartment  Department[]       @relation("DepartmentHead")
  permissions       Json? // Permission set for this position
  assignedModules   Json? // Modules assigned to this position
  maxOccupants      Int                @default(1) // How many people can have this position
  customPermissions Json? // Override default permissions

  // Scheduling & Station Configuration
  jobFunction             JobFunction?
  stationName             String? // "Grill 1", "Server 1-10", "Fry Station", "ICU Nurse"
  stationType             StationType?
  canWorkMultipleStations Boolean      @default(false)
  isStationRequired       Boolean      @default(false) // Must this station be covered daily?
  schedulingPriority      Int? // Higher priority = fill first (1-10)
  defaultStartTime        String? // Default HH:mm start time when scheduling
  defaultEndTime          String? // Default HH:mm end time when scheduling

  employeePositions EmployeePosition[]
  permissionSets    PermissionSet[]
  scheduleShifts    ScheduleShift[]
  shiftTemplates    ShiftTemplate[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@unique([businessId, title])
  @@index([businessId])
  @@index([tierId])
  @@index([departmentId])
  @@index([reportsToId])
  @@index([jobFunction])
  @@index([stationType])
  @@map("positions")
}

// ============================================================================
// SCHEDULING & STATION ENUMS
// ============================================================================

enum JobFunction {
  // Back of House (BOH)
  GRILL
  FRY
  PREP
  PIZZA
  PANTRY
  DISH
  LINE_COOK
  EXPO
  COOK
  CHEF
  // Front of House (FOH)
  SERVER
  HOST
  RUNNER
  BARTENDER
  CASHIER
  BARISTA
  // Management
  MANAGER_ON_DUTY
  SHIFT_LEAD
  SUPERVISOR
  // Healthcare
  NURSE
  CNA
  TECH
  DOCTOR
  // Other
  CUSTOM
}

enum StationType {
  BOH // Back of House
  FOH // Front of House
  MANAGEMENT
  HEALTHCARE
  MANUFACTURING
  OTHER
}

model Permission {
  id           String   @id @default(uuid())
  moduleId     String // Module identifier
  featureId    String // Feature identifier
  action       String // 'view', 'create', 'edit', 'delete', 'manage', 'admin'
  description  String
  category     String // 'basic', 'advanced', 'admin'
  dependencies Json? // Other permissions required
  conflicts    Json? // Conflicting permissions
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([moduleId, featureId, action])
  @@index([moduleId])
  @@index([featureId])
  @@index([action])
  @@index([category])
  @@map("permissions")
}

model PermissionSet {
  id          String     @id @default(uuid())
  business    Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId  String
  name        String // "Full Access", "Executive Access", etc.
  description String?
  permissions Json // Array of permission objects
  category    String // 'basic', 'advanced', 'admin'
  template    Boolean    @default(false) // Whether this is a reusable template
  positions   Position[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([businessId, name])
  @@index([businessId])
  @@index([category])
  @@index([template])
  @@map("permission_sets")
}

model EmployeePosition {
  id                    String                      @id @default(uuid())
  user                  User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String
  position              Position                    @relation(fields: [positionId], references: [id], onDelete: Cascade)
  positionId            String
  business              Business                    @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId            String
  assignedAt            DateTime                    @default(now())
  assignedBy            User                        @relation("EmployeePositionAssignedBy", fields: [assignedById], references: [id])
  assignedById          String
  startDate             DateTime
  endDate               DateTime?
  active                Boolean                     @default(true)
  customPermissions     Json? // Individual overrides
  // HR Module relationships
  hrProfile             EmployeeHRProfile?
  employeeApprovals     ManagerApprovalHierarchy[]  @relation("EmployeeApprovals")
  managerApprovals      ManagerApprovalHierarchy[]  @relation("ManagerApprovals")
  // HR Time-Off back-relation
  timeOffRequests       TimeOffRequest[]            @relation("EmployeePositionTimeOffRequests")
  // HR Attendance back-relations
  attendanceAssignments AttendanceShiftAssignment[] @relation("EmployeeAttendanceAssignments")
  attendanceRecords     AttendanceRecord[]          @relation("EmployeeAttendanceRecords")
  attendanceExceptions  AttendanceException[]       @relation("EmployeeAttendanceExceptions")
  // Scheduling Module back-relations
  scheduleShifts        ScheduleShift[]             @relation("EmployeeScheduleShifts")
  availability          EmployeeAvailability[]      @relation("EmployeeAvailability")
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt

  @@unique([userId, positionId, businessId])
  @@index([userId])
  @@index([positionId])
  @@index([businessId])
  @@index([assignedById])
  @@index([active])
  @@map("employee_positions")
}

model PermissionManagementRights {
  id               String    @id @default(uuid())
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String
  business         Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId       String
  grantedBy        User      @relation("PermissionManagementRightsGrantedBy", fields: [grantedById], references: [id])
  grantedById      String
  grantedAt        DateTime  @default(now())
  scope            Json // Which roles, modules, and levels they can manage
  canGrantToOthers Boolean   @default(false) // Can they give permission management to others?
  expiresAt        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@index([grantedById])
  @@map("permission_management_rights")
}

model PermissionChange {
  id                 String   @id @default(uuid())
  business           Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId         String
  changedBy          User     @relation(fields: [changedById], references: [id])
  changedById        String
  changedAt          DateTime @default(now())
  changeType         String // 'permission_granted', 'permission_revoked', 'role_created', 'role_modified'
  targetRole         String? // Role or position affected
  permissionsChanged Json? // What permissions were changed
  reason             String? // Reason for the change
  createdAt          DateTime @default(now())

  @@index([businessId])
  @@index([changedById])
  @@index([changedAt])
  @@index([changeType])
  @@map("permission_changes")
}

// ============================================================================
// AI MODULE
// ============================================================================

// ============================================================================
// AI & MACHINE LEARNING MODELS
// ============================================================================

model AIPersonalityProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  personalityData Json // Stores PersonalityProfile data
  learningHistory Json[] // Array of learning events
  lastUpdated     DateTime @updatedAt
  createdAt       DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_personality_profiles")
}

model AIAutonomySettings {
  id                 String @id @default(uuid())
  userId             String @unique
  scheduling         Int    @default(30) // 0-100 autonomy level
  communication      Int    @default(20)
  fileManagement     Int    @default(40)
  taskCreation       Int    @default(30)
  dataAnalysis       Int    @default(60)
  crossModuleActions Int    @default(20)

  // Override settings
  workHoursOverride  Boolean @default(false)
  workHoursStart     String? // Time in 24-hour format (HH:MM), e.g., "09:00"
  workHoursEnd       String? // Time in 24-hour format (HH:MM), e.g., "17:00"
  familyTimeOverride Boolean @default(false)
  familyTimeStart    String? // Time in 24-hour format (HH:MM)
  familyTimeEnd      String? // Time in 24-hour format (HH:MM)
  sleepHoursOverride Boolean @default(false)
  sleepHoursStart    String? // Time in 24-hour format (HH:MM)
  sleepHoursEnd      String? // Time in 24-hour format (HH:MM)

  // Approval thresholds
  financialThreshold      Float @default(0) // Dollar amount requiring approval
  timeCommitmentThreshold Int   @default(60) // Minutes requiring approval
  peopleAffectedThreshold Int   @default(1) // Number of people requiring approval

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_autonomy_settings")
}

model AIApprovalRequest {
  id            String          @id @default(uuid())
  userId        String
  requestType   String // Type of action requiring approval
  actionData    Json // Details of the proposed action
  affectedUsers String[] // Array of user IDs affected
  reasoning     String // AI's reasoning for the action
  status        AIRequestStatus @default(PENDING)

  // Response tracking
  responses       Json[] // Array of user responses
  approvedBy      String? // User ID who approved
  rejectedBy      String? // User ID who rejected
  rejectionReason String?

  // Timing
  expiresAt   DateTime
  respondedAt DateTime?
  executedAt  DateTime?
  createdAt   DateTime  @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
  @@map("ai_approval_requests")
}

model AIConversationHistory {
  id              String            @id @default(uuid())
  userId          String
  sessionId       String // Groups related interactions
  interactionType AIInteractionType

  // Request data
  userQuery String
  context   Json // User context at time of request
  priority  String @default("medium")

  // Response data
  aiResponse String
  confidence Float   @default(0.8)
  reasoning  String?
  actions    Json[] // Actions suggested/taken

  // Processing metadata
  provider       String // openai, anthropic, local
  model          String
  tokensUsed     Int    @default(0)
  cost           Float  @default(0)
  processingTime Int    @default(0) // milliseconds

  // Learning and feedback
  userFeedback      String?
  feedbackRating    Int? // 1-10 user satisfaction
  correctionApplied Boolean @default(false)

  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([interactionType])
  @@index([createdAt])
  @@map("ai_conversation_history")
}

model AIUsageTracking {
  id     String @id @default(uuid())
  userId String
  month  Int // 1-12
  year   Int

  // Usage counts
  totalInteractions  Int @default(0)
  queryInteractions  Int @default(0)
  actionRequests     Int @default(0)
  approvalsRequested Int @default(0)
  approvalsGranted   Int @default(0)

  // Cost tracking
  totalCost     Float @default(0)
  openaiCost    Float @default(0)
  anthropicCost Float @default(0)

  // Token usage
  totalTokens  Int @default(0)
  inputTokens  Int @default(0)
  outputTokens Int @default(0)

  // Performance metrics
  avgResponseTime  Int   @default(0) // milliseconds
  avgConfidence    Float @default(0)
  userSatisfaction Float @default(0) // Average feedback rating

  // Feature usage
  crossModuleQueries  Int @default(0)
  personalityLearning Int @default(0)
  proactiveInsights   Int @default(0)
  autonomousActions   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, year])
  @@index([userId])
  @@index([year, month])
  @@map("ai_usage_tracking")
}

model AILearningEvent {
  id        String @id @default(uuid())
  userId    String
  eventType String // correction, reinforcement, pattern_recognition, preference_update
  context   String // Module or situation context

  // Module tracking (NEW: track which module this learning came from)
  sourceModule        String? // Module ID: "drive", "taskpro", "chat", etc.
  sourceModuleVersion String? // Module version: "1.0.0"
  moduleActive        Boolean @default(true) // Is module still installed by user?
  moduleSpecificData  Json? // Module can provide extra context for learning

  // Learning data
  oldBehavior  String? // Previous AI behavior/response
  newBehavior  String // Updated AI behavior/response
  userFeedback String? // User's explicit feedback
  confidence   Float   @default(0.7)

  // Pattern recognition
  patternData Json? // Data about identified patterns
  frequency   Int   @default(1) // How often this pattern occurs

  // Application
  applied   Boolean @default(false)
  validated Boolean @default(false)

  createdAt DateTime @default(now())

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([sourceModule]) // NEW: Fast filtering by module
  @@index([moduleActive]) // NEW: Fast filtering for active modules
  @@index([createdAt])
  @@map("ai_learning_events")
}

// ===== CENTRALIZED AI LEARNING MODELS =====

// Global learning events for centralized pattern recognition
model GlobalLearningEvent {
  id        String @id @default(uuid())
  userId    String // Hashed user ID for privacy
  eventType String // Type of learning event
  context   String // Module or situation context

  // Module tracking (NEW: track which module contributed to global learning)
  sourceModule   String? // Module ID that generated this event
  moduleCategory String? // "productivity", "communication", "finance", etc.

  // Pattern data
  patternData Json? // Anonymized pattern data
  confidence  Float  @default(0.7)
  impact      String // low, medium, high, critical

  // Aggregation
  frequency Int @default(1)

  // Processing
  applied   Boolean @default(false)
  validated Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([context])
  @@index([sourceModule]) // NEW: Fast filtering by module
  @@index([moduleCategory]) // NEW: Fast filtering by category
  @@index([createdAt])
  @@map("global_learning_events")
}

// Global patterns discovered across all users
model GlobalPattern {
  id          String   @id @default(uuid())
  patternType String // behavioral, temporal, preference, workflow, communication
  description String
  frequency   Int // How many users exhibit this pattern
  confidence  Float // 0-1 confidence in the pattern
  strength    Float // 0-1 how strong the pattern is
  modules     String[] // Which modules this pattern affects

  // Module attribution (NEW: track primary module for this pattern)
  primaryModule  String? // "drive", "chat", etc. - main module this pattern relates to
  moduleCategory String? // "productivity", "communication" - category of primary module

  userSegment     String // all, business, personal, household, enterprise
  impact          String // positive, neutral, negative
  recommendations String[]
  dataPoints      Int // Number of data points supporting this pattern
  lastUpdated     DateTime @default(now())
  trend           String // increasing, decreasing, stable
  privacyLevel    String // public, aggregated, anonymized

  createdAt DateTime @default(now())

  @@index([patternType])
  @@index([userSegment])
  @@index([impact])
  @@index([confidence])
  @@index([primaryModule]) // NEW: Fast filtering by primary module
  @@index([moduleCategory]) // NEW: Fast filtering by module category
  @@index([lastUpdated])
  @@map("global_patterns")
}

// Collective insights generated from global patterns
model CollectiveInsight {
  id                       String   @id @default(uuid())
  type                     String // optimization, trend, opportunity, risk, best_practice
  title                    String
  description              String
  confidence               Float
  impact                   String // low, medium, high, critical
  affectedModules          String[]
  affectedUserSegments     String[]
  actionable               Boolean
  recommendations          String[]
  implementationComplexity String // simple, moderate, complex
  estimatedBenefit         Float // 0-1 scale
  dataPoints               Int
  lastValidated            DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([type])
  @@index([impact])
  @@index([actionable])
  @@index([estimatedBenefit])
  @@index([createdAt])
  @@map("collective_insights")
}

// System configuration for AI learning settings
model SystemConfiguration {
  key         String   @id
  value       String // JSON string of configuration
  description String?
  updatedBy   String?
  updatedAt   DateTime @default(now())

  @@map("system_configuration")
}

// ===== ADVANCED AI FEATURES =====

// A/B Testing for AI models and features
model ABTest {
  id             String    @id @default(uuid())
  name           String
  description    String?
  status         String // draft, active, paused, completed
  startDate      DateTime?
  endDate        DateTime?
  trafficSplit   Float     @default(0.5) // Percentage of traffic to test variant
  targetAudience Json? // Audience targeting criteria
  successMetrics String[] // Metrics to track for success
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  variants ABTestVariant[]
  results  ABTestResult[]

  @@index([status])
  @@index([startDate])
  @@map("ab_tests")
}

model ABTestVariant {
  id            String   @id @default(uuid())
  abTestId      String
  abTest        ABTest   @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  config        Json // Variant-specific configuration
  trafficWeight Float    @default(1.0) // Relative traffic weight
  isControl     Boolean  @default(false)
  createdAt     DateTime @default(now())

  results ABTestResult[]

  @@index([abTestId])
  @@map("ab_test_variants")
}

model ABTestResult {
  id        String        @id @default(uuid())
  abTestId  String
  abTest    ABTest        @relation(fields: [abTestId], references: [id], onDelete: Cascade)
  variantId String
  variant   ABTestVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  userId    String?
  sessionId String?
  eventType String // impression, click, conversion, etc.
  eventData Json?
  timestamp DateTime      @default(now())

  @@index([abTestId])
  @@index([variantId])
  @@index([userId])
  @@index([timestamp])
  @@map("ab_test_results")
}

// Workflow automation and decision support
model WorkflowDefinition {
  id          String   @id @default(uuid())
  name        String
  description String?
  version     String   @default("1.0.0")
  status      String // draft, active, archived
  category    String // business_process, data_pipeline, ml_pipeline
  triggers    Json // Workflow trigger conditions
  steps       Json // Workflow step definitions
  variables   Json // Workflow variables and configuration
  metadata    Json? // Additional workflow metadata
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  executions WorkflowExecution[]

  @@index([status])
  @@index([category])
  @@index([createdBy])
  @@map("workflow_definitions")
}

model WorkflowExecution {
  id          String             @id @default(uuid())
  workflowId  String
  workflow    WorkflowDefinition @relation(fields: [workflowId], references: [id])
  status      String // running, completed, failed, cancelled
  startedAt   DateTime           @default(now())
  completedAt DateTime?
  input       Json? // Input data for the workflow
  output      Json? // Output data from the workflow
  error       String? // Error message if failed
  metadata    Json? // Execution metadata

  @@index([workflowId])
  @@index([status])
  @@index([startedAt])
  @@map("workflow_executions")
}

// AI Model Management
model AIModel {
  id           String   @id @default(uuid())
  name         String
  description  String?
  version      String   @default("1.0.0")
  modelType    String // classification, regression, forecasting, etc.
  framework    String // tensorflow, pytorch, scikit-learn, etc.
  status       String // training, deployed, archived
  performance  Json? // Model performance metrics
  metadata     Json? // Model metadata and configuration
  artifacts    Json? // Model artifacts and files
  trainingData Json? // Training data information
  createdBy    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  versions    AIModelVersion[]
  deployments AIModelDeployment[]
  experiments AIModelExperiment[]
  abTests     ModelABTest[]

  @@index([modelType])
  @@index([status])
  @@index([createdBy])
  @@map("ai_models")
}

model AIModelVersion {
  id              String    @id @default(uuid())
  modelId         String
  model           AIModel   @relation(fields: [modelId], references: [id], onDelete: Cascade)
  version         String
  description     String?
  performance     Json? // Version-specific performance metrics
  artifacts       Json? // Version-specific artifacts
  trainingMetrics Json? // Training metrics and logs
  deployedAt      DateTime?
  createdAt       DateTime  @default(now())

  deployments AIModelDeployment[]

  @@index([modelId])
  @@index([version])
  @@map("ai_model_versions")
}

model AIModelDeployment {
  id            String         @id @default(uuid())
  modelId       String
  model         AIModel        @relation(fields: [modelId], references: [id])
  versionId     String
  version       AIModelVersion @relation(fields: [versionId], references: [id])
  environment   String // development, staging, production
  status        String // deploying, active, failed, inactive
  endpoint      String? // API endpoint URL
  config        Json? // Deployment configuration
  deployedAt    DateTime       @default(now())
  deactivatedAt DateTime?

  @@index([modelId])
  @@index([versionId])
  @@index([environment])
  @@index([status])
  @@map("ai_model_deployments")
}

model AIModelExperiment {
  id          String    @id @default(uuid())
  modelId     String
  model       AIModel   @relation(fields: [modelId], references: [id])
  name        String
  description String?
  status      String // running, completed, failed
  config      Json // Experiment configuration
  results     Json? // Experiment results
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([modelId])
  @@index([status])
  @@map("ai_model_experiments")
}

model ModelABTest {
  id           String    @id @default(uuid())
  modelId      String
  model        AIModel   @relation(fields: [modelId], references: [id])
  name         String
  description  String?
  status       String // active, completed, cancelled
  variants     String[] // Model version IDs to test
  trafficSplit Json // Traffic distribution configuration
  metrics      String[] // Metrics to track
  startDate    DateTime  @default(now())
  endDate      DateTime?
  results      Json? // A/B test results

  @@index([modelId])
  @@index([status])
  @@map("model_ab_tests")
}

// User-defined AI Context - Manual context entries for AI understanding
model UserAIContext {
  id          String   @id @default(uuid())
  userId      String
  scope       String // "personal" | "business" | "module" | "folder" | "project"
  scopeId     String? // businessId, moduleId, folderId, projectId, etc.
  moduleId    String? // For module-scoped context (e.g., "drive", "chat")
  contextType String // "instruction" | "fact" | "preference" | "workflow"
  title       String // User-friendly title
  content     String // The actual context to remember
  tags        String[] // For organization and filtering
  priority    Int      @default(50) // 0-100, affects when AI uses this
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scope, scopeId])
  @@index([moduleId])
  @@index([contextType])
  @@index([active])
  @@map("user_ai_context")
}

// AutoML Service
model AutoMLJob {
  id              String    @id @default(uuid())
  name            String
  description     String?
  status          String // pending, running, completed, failed
  dataset         Json // Dataset configuration
  task            String // classification, regression, forecasting
  algorithms      String[] // Algorithms to try
  hyperparameters Json? // Hyperparameter search space
  constraints     Json? // Resource and time constraints
  results         Json? // Job results and best model
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  createdBy       String?

  trials AutoMLTrial[]

  @@index([status])
  @@index([task])
  @@index([createdBy])
  @@map("automl_jobs")
}

model AutoMLTrial {
  id              String    @id @default(uuid())
  jobId           String
  job             AutoMLJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  trialNumber     Int
  algorithm       String
  hyperparameters Json // Trial-specific hyperparameters
  performance     Json? // Trial performance metrics
  status          String // running, completed, failed
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  @@index([jobId])
  @@index([trialNumber])
  @@index([status])
  @@map("automl_trials")
}

// ============================================================================
// AI MODULE
// ============================================================================

// ============================================================================
// ANALYTICS & INTELLIGENCE PLATFORM MODELS
// ============================================================================

// Real-time Analytics
model DataStream {
  id          String   @id @default(uuid())
  name        String
  description String?
  source      String // workflow, ai_model, user_activity, system_metrics
  schema      Json // Data stream schema
  status      String // active, paused, archived
  config      Json? // Stream configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dataPoints DataPoint[]
  processors StreamProcessor[]

  @@index([source])
  @@index([status])
  @@map("data_streams")
}

model DataPoint {
  id        String     @id @default(uuid())
  streamId  String
  stream    DataStream @relation(fields: [streamId], references: [id])
  timestamp DateTime   @default(now())
  data      Json // Actual data values
  metadata  Json? // Additional metadata

  @@index([streamId])
  @@index([timestamp])
  @@map("data_points")
}

model StreamProcessor {
  id        String     @id @default(uuid())
  streamId  String
  stream    DataStream @relation(fields: [streamId], references: [id])
  name      String
  type      String // filter, transform, aggregate, ml_model
  config    Json // Processor configuration
  status    String // active, paused, error
  createdAt DateTime   @default(now())

  @@index([streamId])
  @@index([type])
  @@map("stream_processors")
}

model RealTimeMetric {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String // performance, business, user, system
  value       Float
  unit        String?
  tags        Json? // Key-value tags
  timestamp   DateTime @default(now())

  @@index([name])
  @@index([category])
  @@index([timestamp])
  @@map("real_time_metrics")
}

model RealTimeAlert {
  id             String    @id @default(uuid())
  metricName     String
  condition      String // threshold, trend, anomaly
  threshold      Float?
  severity       String // low, medium, high, critical
  message        String
  status         String // active, acknowledged, resolved
  triggeredAt    DateTime  @default(now())
  acknowledgedAt DateTime?
  resolvedAt     DateTime?

  @@index([metricName])
  @@index([severity])
  @@index([status])
  @@map("real_time_alerts")
}

// Analytics Dashboards
model AnalyticsDashboard {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String // business, technical, user, ai
  layout      Json // Dashboard layout configuration
  config      Json? // Dashboard configuration
  isPublic    Boolean  @default(false)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  widgets DashboardWidget[]

  @@index([category])
  @@index([createdBy])
  @@map("analytics_dashboards")
}

model DashboardWidget {
  id              String             @id @default(uuid())
  dashboardId     String
  dashboard       AnalyticsDashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  name            String
  type            String // line, bar, pie, scatter, area, heatmap, metric
  config          Json // Widget configuration
  position        Json // Widget position in dashboard
  dataSource      String? // Data source for the widget
  refreshInterval Int? // Refresh interval in seconds

  @@index([dashboardId])
  @@index([type])
  @@map("dashboard_widgets")
}

// Predictive Intelligence
model ForecastingModel {
  id          String   @id @default(uuid())
  name        String
  description String?
  modelType   String // arima, lstm, random_forest, etc.
  algorithm   String // Specific algorithm implementation
  config      Json // Model configuration
  performance Json? // Model performance metrics
  status      String // training, active, archived
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  forecasts Forecast[]

  @@index([modelType])
  @@index([status])
  @@map("forecasting_models")
}

model Forecast {
  id         String           @id @default(uuid())
  modelId    String
  model      ForecastingModel @relation(fields: [modelId], references: [id])
  horizon    Int // Forecast horizon in time units
  confidence Float // Confidence level (0-1)
  data       Json // Forecast data points
  metadata   Json? // Additional forecast metadata
  createdAt  DateTime         @default(now())
  expiresAt  DateTime?

  @@index([modelId])
  @@index([horizon])
  @@index([createdAt])
  @@map("forecasts")
}

model AnomalyDetectionModel {
  id          String   @id @default(uuid())
  name        String
  description String?
  modelType   String // statistical, isolation_forest, autoencoder, etc.
  algorithm   String // Specific algorithm implementation
  config      Json // Model configuration
  performance Json? // Model performance metrics
  status      String // training, active, archived
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  anomalies Anomaly[]

  @@index([modelType])
  @@index([status])
  @@map("anomaly_detection_models")
}

model Anomaly {
  id         String                @id @default(uuid())
  modelId    String
  model      AnomalyDetectionModel @relation(fields: [modelId], references: [id])
  severity   String // low, medium, high, critical
  data       Json // Anomaly data and context
  detectedAt DateTime              @default(now())
  status     String // new, investigating, resolved, false_positive

  @@index([modelId])
  @@index([severity])
  @@index([detectedAt])
  @@map("anomalies")
}

// Business Intelligence
model BusinessMetric {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String // financial, operational, customer, product
  value       Float
  unit        String?
  target      Float?
  trend       String // increasing, decreasing, stable
  lastUpdated DateTime @default(now())

  @@index([name])
  @@index([category])
  @@index([lastUpdated])
  @@map("business_metrics")
}

model KPIDashboard {
  id          String   @id @default(uuid())
  name        String
  description String?
  category    String // executive, operational, tactical
  layout      Json // Dashboard layout
  config      Json? // Dashboard configuration
  isPublic    Boolean  @default(false)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([createdBy])
  @@map("kpi_dashboards")
}

// AI-Powered Insights
model PatternDiscovery {
  id           String   @id @default(uuid())
  name         String
  description  String?
  patternType  String // behavioral, temporal, correlation, etc.
  confidence   Float // Confidence in the discovery (0-1)
  data         Json // Pattern data and evidence
  metadata     Json? // Additional metadata
  discoveredAt DateTime @default(now())

  @@index([patternType])
  @@index([confidence])
  @@index([discoveredAt])
  @@map("pattern_discoveries")
}

model IntelligentInsight {
  id              String   @id @default(uuid())
  type            String // pattern, prediction, trend, recommendation, anomaly, correlation
  title           String
  description     String
  confidence      Float // Confidence in the insight (0-1)
  impact          String // low, medium, high, critical
  data            Json // Insight data and context
  actionable      Boolean  @default(false)
  recommendations String[]
  createdAt       DateTime @default(now())

  @@index([type])
  @@index([impact])
  @@index([actionable])
  @@index([createdAt])
  @@map("intelligent_insights")
}

model Recommendation {
  id          String    @id @default(uuid())
  type        String // optimization, feature, workflow, security
  title       String
  description String
  priority    String // low, medium, high, critical
  status      String // pending, approved, implemented, rejected
  impact      String // low, medium, high, critical
  effort      String // low, medium, high
  data        Json // Recommendation data and context
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([type])
  @@index([priority])
  @@index([status])
  @@index([impact])
  @@map("recommendations")
}

// ============================================================================
// AI MODULE
// ============================================================================

// AI Conversations Module
// Handles persistent AI chat conversations and messages

model AIConversation {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  title         String // Auto-generated from first message or user-defined
  dashboardId   String? // Optional: scope to specific dashboard
  dashboard     Dashboard?  @relation(fields: [dashboardId], references: [id], onDelete: SetNull)
  businessId    String? // Optional: scope to specific business
  business      Business?   @relation(fields: [businessId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastMessageAt DateTime    @default(now())
  isArchived    Boolean     @default(false)
  isPinned      Boolean     @default(false)
  messageCount  Int         @default(0)
  trashedAt     DateTime? // Global trash system support
  messages      AIMessage[]

  // Indexes for performance
  @@index([userId, lastMessageAt])
  @@index([dashboardId])
  @@index([businessId])
  @@index([isArchived, lastMessageAt])
  @@index([trashedAt])
  @@map("ai_conversations")
}

model AIMessage {
  id             String         @id @default(cuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String // 'user' | 'assistant' | 'system'
  content        String         @db.Text
  confidence     Float? // AI response confidence (0-1)
  metadata       Json? // Store reasoning, actions, insights, model info
  createdAt      DateTime       @default(now())

  // Indexes for performance
  @@index([conversationId, createdAt])
  @@index([role, createdAt])
  @@map("ai_messages")
}

// ============================================================================
// AI MODULE
// ============================================================================

// ============================================================================
// ENTERPRISE AI DIGITAL TWIN MODELS
// ============================================================================

model BusinessAIDigitalTwin {
  id         String   @id @default(uuid())
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String   @unique

  // AI Configuration
  name          String  @default("Business AI Assistant")
  description   String?
  aiPersonality Json // Business-specific AI personality traits
  capabilities  Json // Enabled AI capabilities and features
  restrictions  Json // Security restrictions and limitations

  // Training & Learning Configuration
  trainingData       Json? // Business-specific training data references
  learningSettings   Json // Learning preferences and controls
  performanceMetrics Json? // AI performance tracking and analytics

  // Security & Compliance
  securityLevel      String  @default("standard") // standard, high, maximum
  complianceMode     Boolean @default(false)
  dataRetentionDays  Int     @default(365) // Data retention period
  auditSettings      Json // Audit and logging configuration
  encryptionRequired Boolean @default(true)

  // Access Control
  adminUsers               String[] // User IDs with master control access
  delegatedAdmins          String[] // Users with limited admin rights
  allowEmployeeInteraction Boolean  @default(true)
  allowCentralizedLearning Boolean  @default(false)

  // Status & Metadata
  status                    String    @default("active") // active, paused, maintenance
  lastTrainingAt            DateTime?
  lastInteractionAt         DateTime?
  lastCentralizedLearningAt DateTime? // Track when last fed to centralized system
  totalInteractions         Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  interactions   BusinessAIInteraction[]
  learningEvents BusinessAILearningEvent[]
  usageMetrics   BusinessAIUsageMetric[]

  @@index([businessId])
  @@index([status])
  @@index([securityLevel])
  @@map("business_ai_digital_twins")
}

model BusinessAIInteraction {
  id           String                @id @default(uuid())
  businessAI   BusinessAIDigitalTwin @relation(fields: [businessAIId], references: [id], onDelete: Cascade)
  businessAIId String
  userId       String // Employee who interacted

  // Interaction Details
  interactionType String // query, command, feedback, training, analysis
  userInput       String
  aiResponse      String
  confidence      Float  @default(0.8)
  processingTime  Int    @default(0) // Processing time in milliseconds

  // Context & Metadata
  contextData   Json // Business context at time of interaction
  moduleContext String? // Which module the interaction occurred in
  userRole      String? // User's role/position during interaction
  departmentId  String? // Department context

  // Security & Compliance
  securityLevel      String // Level of security for this interaction
  complianceFlags    Json? // Any compliance considerations
  auditMetadata      Json? // Audit trail information
  dataClassification String @default("internal") // public, internal, confidential, restricted

  // Feedback & Learning
  userFeedback      String? // User's feedback on AI response
  feedbackRating    Int? // 1-10 satisfaction rating
  wasHelpful        Boolean? // Simple helpful/not helpful feedback
  correctionApplied Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([businessAIId])
  @@index([userId])
  @@index([interactionType])
  @@index([createdAt])
  @@index([moduleContext])
  @@map("business_ai_interactions")
}

model BusinessAILearningEvent {
  id           String                @id @default(uuid())
  businessAI   BusinessAIDigitalTwin @relation(fields: [businessAIId], references: [id], onDelete: Cascade)
  businessAIId String

  // Learning Event Details
  eventType    String // training, correction, policy_update, feedback, pattern_discovery
  sourceUserId String? // Who triggered the learning event
  sourceType   String // user_feedback, admin_training, automated_discovery, external_data

  // Learning Content
  learningData     Json // What the AI learned
  previousBehavior String? // AI's previous behavior/response
  newBehavior      String // Updated AI behavior/response
  confidence       Float   @default(0.7)
  impact           String  @default("medium") // low, medium, high, critical

  // Validation & Approval
  requiresApproval Boolean   @default(true)
  approved         Boolean   @default(false)
  approvedBy       String? // Admin who approved
  approvedAt       DateTime?
  rejectionReason  String? // If rejected, why

  // Privacy & Security
  privacyLevel       String  @default("internal") // public, internal, confidential, restricted
  dataClassification String  @default("business_process")
  complianceReview   Boolean @default(false)

  // Application & Results
  applied           Boolean   @default(false)
  appliedAt         DateTime?
  effectiveness     Float? // 0-1 how effective the learning was
  rollbackAvailable Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessAIId])
  @@index([eventType])
  @@index([sourceUserId])
  @@index([approved])
  @@index([createdAt])
  @@map("business_ai_learning_events")
}

model BusinessAIUsageMetric {
  id           String                @id @default(uuid())
  businessAI   BusinessAIDigitalTwin @relation(fields: [businessAIId], references: [id], onDelete: Cascade)
  businessAIId String

  // Time Period
  date   DateTime @default(now())
  period String // daily, weekly, monthly

  // Usage Statistics
  totalInteractions   Int   @default(0)
  uniqueUsers         Int   @default(0)
  averageResponseTime Int   @default(0) // milliseconds
  averageConfidence   Float @default(0.0)
  averageUserRating   Float @default(0.0)

  // Capability Usage
  queryInteractions Int @default(0)
  commandExecutions Int @default(0)
  analysisRequests  Int @default(0)
  trainingEvents    Int @default(0)

  // Performance Metrics
  successfulResponses Int @default(0)
  failedResponses     Int @default(0)
  timeoutResponses    Int @default(0)
  userCorrections     Int @default(0)

  // Department Breakdown
  departmentUsage Json? // Usage statistics by department
  roleUsage       Json? // Usage statistics by user role
  moduleUsage     Json? // Usage statistics by module

  // AI Learning Metrics
  learningEventsGenerated Int   @default(0)
  learningEventsApproved  Int   @default(0)
  learningEventsApplied   Int   @default(0)
  knowledgeBaseGrowth     Float @default(0.0)

  createdAt DateTime @default(now())

  @@unique([businessAIId, date, period])
  @@index([businessAIId])
  @@index([date])
  @@index([period])
  @@map("business_ai_usage_metrics")
}

// ============================================================================
// AI MODULE
// ============================================================================

// ============================================================================
// MODULE AI CONTEXT REGISTRY
// ============================================================================
// This schema enables the AI system to dynamically understand and work with
// any module (built-in or third-party) through a fast, queryable registry.

// Central registry of all module AI contexts
model ModuleAIContextRegistry {
  id         String @id @default(uuid())
  moduleId   String @unique
  moduleName String

  // Module purpose and category (for fast filtering and display)
  purpose  String // "File storage and management"
  category String // "productivity", "communication", "finance", etc.

  // Semantic rules for AI matching (INDEXED for ultra-fast keyword search)
  keywords String[] // ["file", "upload", "download", "document", "pdf"]
  patterns String[] // ["upload * to drive", "show my files", "find files from *"]
  concepts String[] // ["storage", "documents", "sharing", "collaboration"]

  // Entities this module manages
  // Example: [{ name: "file", pluralName: "files", description: "A digital file" }]
  entities Json

  // Available actions users can take
  // Example: [{ name: "upload", description: "Upload file", permissions: ["drive:write"] }]
  actions Json

  // Context providers - endpoints the AI calls to get live data
  // Example: [{ name: "recentFiles", endpoint: "/api/modules/:id/ai/context/recent", cacheDuration: 900000 }]
  contextProviders Json

  // Queryable data - structured queries the AI can make
  // Example: [{ dataType: "fileCount", endpoint: "/api/modules/:id/ai/count", parameters: {...} }]
  queryableData Json?

  // Relationships to other modules (for cross-module insights)
  // Example: [{ module: "chat", type: "integrates", description: "Files shared in chat" }]
  relationships Json?

  // Full AI context definition from manifest (for reference and debugging)
  fullAIContext Json

  // Metadata
  version     String   @default("1.0.0")
  lastUpdated DateTime @updatedAt
  createdAt   DateTime @default(now())

  // Relationships
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  // Performance-critical indexes
  @@index([keywords]) // Fast keyword search for AI query matching
  @@index([category]) // Fast category filtering
  @@index([moduleName]) // Fast name lookup
  @@map("module_ai_context_registry")
}

// User-specific AI context cache for performance optimization
model UserAIContextCache {
  id     String @id @default(uuid())
  userId String @unique

  // Cached context from all installed modules
  // Stored as complete UserContext object from CrossModuleContextEngine
  cachedContext Json

  // Cache metadata
  lastUpdated DateTime @default(now())
  expiresAt   DateTime // Auto-refresh after this time (typically 15 minutes)
  version     String   @default("1.0.0")

  // Cache statistics
  hitCount  Int @default(0) // How many times this cache was used
  missCount Int @default(0) // How many times cache expired

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt]) // Fast expiration checking
  @@map("user_ai_context_cache")
}

// Module AI performance metrics for monitoring and analytics
model ModuleAIPerformanceMetric {
  id       String   @id @default(uuid())
  moduleId String
  date     DateTime @default(now())

  // Query metrics
  totalQueries      Int   @default(0) // Total AI queries involving this module
  successfulQueries Int   @default(0) // Successful context fetches
  failedQueries     Int   @default(0) // Failed context fetches
  averageLatency    Float @default(0) // Average response time in ms

  // Context metrics
  contextFetchCount  Int   @default(0) // How many times context was fetched
  contextFetchErrors Int   @default(0) // Context fetch errors
  averageContextSize Float @default(0) // Average context payload size in KB
  cacheHitRate       Float @default(0) // % of queries using cached context

  // User satisfaction metrics
  positiveRatings Int   @default(0) // User thumbs up on AI responses
  negativeRatings Int   @default(0) // User thumbs down on AI responses
  averageRating   Float @default(0) // Average rating (0-10)

  // Cost tracking
  estimatedCost Float @default(0) // Estimated AI API costs for this module
  tokenCount    Int   @default(0) // Total tokens used

  // AI learning contribution
  learningEventsGenerated Int @default(0) // Learning events from this module
  patternsContributed     Int @default(0) // Global patterns this module contributed to

  // Relationships
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([moduleId, date])
  @@index([moduleId])
  @@index([date])
  @@map("module_ai_performance_metrics")
}

// ============================================================================
// BILLING MODULE
// ============================================================================

// ============================================================================
// AI QUERY BALANCE & PURCHASE MODELS
// ============================================================================

// AI Query Balance - Tracks user's available AI queries
model AIQueryBalance {
  id         String  @id @default(uuid())
  userId     String
  businessId String?

  // Base allowance from subscription tier
  baseAllowance     Int @default(0)
  baseAllowanceUsed Int @default(0)

  // Purchased query packs (never expire)
  purchasedQueries     Int @default(0)
  purchasedQueriesUsed Int @default(0)

  // Current billing period tracking
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  // Rollover tracking (unused base allowance from previous periods)
  queriesRolledOver Int @default(0)

  // Spending limit for overage queries (Cursor-style)
  monthlySpendingLimit  Float @default(0) // Monthly limit in dollars (0 = disabled)
  currentPeriodSpending Float @default(0) // Current period spending in dollars

  // Overage tracking
  overageQueriesUsed Int   @default(0) // Number of overage queries used this period
  overageQueriesCost Float @default(0) // Total cost of overage queries this period

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  business  Business?         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  purchases AIQueryPurchase[]

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@index([currentPeriodStart])
  @@map("ai_query_balances")
}

// Query pack purchase records
model AIQueryPurchase {
  id         String  @id @default(uuid())
  userId     String
  businessId String?
  balanceId  String? // Link to balance record

  packType              String // 'small', 'medium', 'large', 'enterprise'
  queriesAmount         Int
  amountPaid            Float
  currency              String  @default("USD")
  stripePaymentIntentId String? @unique
  stripeChargeId        String?

  status String @default("pending") // 'pending', 'completed', 'failed', 'refunded'

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  // Relationships
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business?       @relation(fields: [businessId], references: [id], onDelete: Cascade)
  balance  AIQueryBalance? @relation(fields: [balanceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([businessId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([createdAt])
  @@map("ai_query_purchases")
}

// ============================================================================
// BILLING MODULE
// ============================================================================

// ============================================================================
// PRICING CONFIGURATION MODELS
// ============================================================================

// Pricing configuration for subscription tiers
model PricingConfig {
  id           String @id @default(uuid())
  tier         String // 'free', 'pro', 'business_basic', 'business_advanced', 'enterprise'
  billingCycle String // 'monthly', 'yearly'

  // Pricing
  basePrice         Float
  perEmployeePrice  Float? // For business tiers
  includedEmployees Int? // For business tiers

  // AI Query Packs (optional - for future implementation)
  queryPackSmall      Float? // 500 queries
  queryPackMedium     Float? // 2,500 queries
  queryPackLarge      Float? // 5,000 queries
  queryPackEnterprise Float? // 10,000 queries

  // Base AI Allowances (optional - for future implementation)
  baseAIAllowance Int? // Queries included per month

  // Stripe Integration
  stripePriceId            String? // Stripe price ID for base subscription
  perEmployeeStripePriceId String? // Stripe price ID for per-employee charges

  // Status
  isActive      Boolean   @default(true)
  effectiveDate DateTime // When this pricing takes effect
  endDate       DateTime? // When this pricing expires (for future changes)

  // Metadata
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  createdByUser User          @relation("PricingConfigCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)
  priceChanges  PriceChange[]

  @@unique([tier, billingCycle, effectiveDate])
  @@index([tier, isActive])
  @@index([effectiveDate])
  @@index([tier, billingCycle])
  @@map("pricing_configs")
}

// Price change history and audit trail
model PriceChange {
  id                 String    @id @default(uuid())
  pricingConfigId    String
  changeType         String // 'base_price', 'per_employee', 'query_pack', etc.
  oldValue           Float
  newValue           Float
  reason             String?
  notificationSent   Boolean   @default(false)
  notificationSentAt DateTime?

  createdBy String
  createdAt DateTime @default(now())

  // Relationships
  pricingConfig PricingConfig @relation(fields: [pricingConfigId], references: [id], onDelete: Cascade)
  createdByUser User          @relation("PriceChangeCreatedBy", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([pricingConfigId])
  @@index([createdAt])
  @@index([changeType])
  @@map("price_changes")
}

// ============================================================================
// BILLING MODULE
// ============================================================================

// ============================================================================
// BILLING & SUBSCRIPTION MODELS
// ============================================================================

// Core tier subscriptions (Free, Pro, Business Basic/Advanced, Enterprise)
model Subscription {
  id                   String   @id @default(uuid())
  userId               String
  businessId           String?
  tier                 String // 'free', 'pro', 'business_basic', 'business_advanced', 'enterprise'
  status               String // 'active', 'cancelled', 'past_due', 'unpaid'
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  stripeSubscriptionId String?
  stripeCustomerId     String?

  // Stripe integration fields
  lastSyncedAt   DateTime? // Last time synced from Stripe
  stripeMetadata Json? // Store additional Stripe subscription data

  // Business-specific fields
  employeeCount          Int? // Total employees for business plans
  includedEmployees      Int? // Included employees (10 for business plans)
  additionalEmployeeCost Float? // Cost for additional employees

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  business            Business?            @relation(fields: [businessId], references: [id], onDelete: Cascade)
  moduleSubscriptions ModuleSubscription[]
  usageRecords        UsageRecord[]
  invoices            Invoice[]

  @@index([userId])
  @@index([businessId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

// Module-specific subscriptions (App Store model)
model ModuleSubscription {
  id                   String   @id @default(uuid())
  userId               String
  businessId           String?
  moduleId             String
  coreSubscriptionId   String?
  tier                 String // 'premium', 'enterprise'
  status               String // 'active', 'cancelled', 'past_due'
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean  @default(false)
  stripeSubscriptionId String?
  stripeCustomerId     String?
  amount               Float
  platformRevenue      Float    @default(0) // For third-party modules
  developerRevenue     Float    @default(0) // For third-party modules
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relationships
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  business         Business?     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  module           Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  coreSubscription Subscription? @relation(fields: [coreSubscriptionId], references: [id], onDelete: SetNull)
  usageRecords     UsageRecord[]
  invoices         Invoice[]

  @@index([userId])
  @@index([businessId])
  @@index([moduleId])
  @@index([status])
  @@map("module_subscriptions")
}

// Usage tracking for both core tiers and modules
model UsageRecord {
  id                   String   @id @default(uuid())
  subscriptionId       String?
  moduleSubscriptionId String?
  userId               String
  businessId           String?
  metric               String // 'api_calls', 'storage_gb', 'ai_requests', 'messages', 'files'
  quantity             Int
  cost                 Float
  periodStart          DateTime
  periodEnd            DateTime
  createdAt            DateTime @default(now())

  // Relationships
  subscription       Subscription?       @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  moduleSubscription ModuleSubscription? @relation(fields: [moduleSubscriptionId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  business           Business?           @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([moduleSubscriptionId])
  @@index([userId])
  @@index([metric])
  @@index([periodStart])
  @@map("usage_records")
}

// Invoice management
model Invoice {
  id                   String    @id @default(uuid())
  subscriptionId       String?
  moduleSubscriptionId String?
  businessId           String?
  amount               Float
  currency             String    @default("USD")
  status               String // 'draft', 'open', 'paid', 'void', 'uncollectible'
  stripeInvoiceId      String?
  dueDate              DateTime?
  paidAt               DateTime?
  createdAt            DateTime  @default(now())

  // Stripe integration fields
  stripeChargeId        String? // Stripe charge ID
  stripePaymentIntentId String? // Stripe payment intent ID
  stripeCustomerId      String? // Stripe customer ID
  stripeFee             Float? // Stripe processing fee
  stripeNetAmount       Float? // Net amount after Stripe fees
  refundAmount          Float?    @default(0) // Total refunded amount
  refundCount           Int?      @default(0) // Number of refunds
  lastSyncedAt          DateTime? // Last time synced from Stripe

  // Additional Stripe metadata
  stripeMetadata Json? // Store additional Stripe data (payment method, disputes, etc.)

  // Relationships
  subscription       Subscription?       @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  moduleSubscription ModuleSubscription? @relation(fields: [moduleSubscriptionId], references: [id], onDelete: Cascade)
  business           Business?           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user               User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId             String?
  refunds            Refund[] // Related refunds

  @@index([subscriptionId])
  @@index([moduleSubscriptionId])
  @@index([businessId])
  @@index([status])
  @@index([stripeInvoiceId])
  @@index([stripeChargeId])
  @@map("invoices")
}

// Refund tracking
model Refund {
  id             String    @id @default(uuid())
  invoiceId      String
  amount         Float
  currency       String    @default("USD")
  reason         String? // 'duplicate', 'fraudulent', 'requested_by_customer', etc.
  status         String // 'pending', 'succeeded', 'failed', 'canceled'
  stripeRefundId String?   @unique // Stripe refund ID
  stripeChargeId String? // Original charge ID
  createdAt      DateTime  @default(now())
  processedAt    DateTime?

  // Relationships
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([stripeRefundId])
  @@map("refunds")
}

// Developer revenue tracking for third-party modules
model DeveloperRevenue {
  id               String    @id @default(uuid())
  developerId      String
  moduleId         String
  periodStart      DateTime
  periodEnd        DateTime
  totalRevenue     Float
  platformRevenue  Float
  developerRevenue Float
  payoutStatus     String    @default("pending") // 'pending', 'paid', 'failed'
  payoutDate       DateTime?
  createdAt        DateTime  @default(now())

  // Apple-style revenue split tracking
  commissionRate        Float // Actual commission rate used (0.15 or 0.30)
  commissionType        String // 'standard', 'small_business', 'long_term'
  subscriptionAgeMonths Int // Age of subscription when revenue was calculated
  isFirstYear           Boolean @default(true) // True if subscription is in first year

  // Relationships
  developer User   @relation(fields: [developerId], references: [id], onDelete: Cascade)
  module    Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([developerId])
  @@index([moduleId])
  @@index([periodStart])
  @@index([commissionType])
  @@map("developer_revenue")
}

// ============================================================================
// CALENDAR MODULE
// ============================================================================

// ============================================================================
// CALENDAR & EVENT MODELS
// ============================================================================

model Calendar {
  id                     String              @id @default(uuid())
  name                   String
  color                  String?
  type                   CalendarType        @default(LOCAL)
  contextType            CalendarContextType
  contextId              String
  isPrimary              Boolean             @default(false)
  isSystem               Boolean             @default(false)
  isDeletable            Boolean             @default(true)
  defaultReminderMinutes Int                 @default(10)
  visibility             String? // future: private/public/link
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt

  // Relationships
  events  Event[]
  members CalendarMember[]

  @@index([contextType, contextId])
  @@map("calendars")
}

model CalendarMember {
  id         String   @id @default(uuid())
  calendar   Calendar @relation(fields: [calendarId], references: [id])
  calendarId String
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  role       String // OWNER | ADMIN | EDITOR | READER | FREE_BUSY
  createdAt  DateTime @default(now())

  @@unique([calendarId, userId])
  @@index([userId])
  @@map("calendar_members")
}

model Event {
  id                String      @id @default(uuid())
  calendar          Calendar    @relation(fields: [calendarId], references: [id])
  calendarId        String
  title             String
  description       String?
  location          String?
  onlineMeetingLink String?
  startAt           DateTime
  endAt             DateTime
  allDay            Boolean     @default(false)
  timezone          String      @default("UTC")
  status            EventStatus @default(CONFIRMED)
  // Recurrence (RRULE) support
  recurrenceRule    String?
  recurrenceEndAt   DateTime?
  parentEventId     String?
  parentEvent       Event?      @relation("EventRecurrence", fields: [parentEventId], references: [id])
  exceptions        Event[]     @relation("EventRecurrence")
  createdById       String?
  updatedById       String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  trashedAt         DateTime? // Global trash system support

  attendees   EventAttendee[]
  reminders   Reminder[]
  attachments EventAttachment[]
  comments    EventComment[]
  rsvpTokens  RsvpToken[]

  @@index([calendarId])
  @@index([startAt, endAt])
  @@index([trashedAt])
  @@map("events")
}

model EventAttendee {
  id       String  @id @default(uuid())
  event    Event   @relation(fields: [eventId], references: [id])
  eventId  String
  userId   String?
  email    String?
  response String? // NEEDS_ACTION | ACCEPTED | DECLINED | TENTATIVE

  @@index([eventId])
  @@map("event_attendees")
}

model Reminder {
  id            String         @id @default(uuid())
  event         Event          @relation(fields: [eventId], references: [id])
  eventId       String
  method        ReminderMethod @default(APP)
  minutesBefore Int            @default(10)
  dispatchedAt  DateTime?

  @@index([eventId])
  @@map("reminders")
}

model EventAttachment {
  id          String  @id @default(uuid())
  event       Event   @relation(fields: [eventId], references: [id])
  eventId     String
  driveFileId String?
  externalUrl String?

  @@index([eventId])
  @@map("event_attachments")
}

model EventComment {
  id        String   @id @default(uuid())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([userId])
  @@map("event_comments")
}

model RsvpToken {
  id            String   @id @default(uuid())
  token         String   @unique
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventId       String
  attendeeEmail String
  response      String // The response this token represents
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@index([token])
  @@index([eventId])
  @@map("rsvp_tokens")
}

// ============================================================================
// DRIVE MODULE
// ============================================================================

// ============================================================================
// DRIVE & FILE MANAGEMENT MODELS
// ============================================================================

model File {
  id             String           @id @default(uuid())
  user           User             @relation(fields: [userId], references: [id])
  userId         String
  name           String
  path           String?
  type           String
  size           Int
  url            String
  folder         Folder?          @relation(fields: [folderId], references: [id])
  folderId       String?
  dashboard      Dashboard?       @relation(fields: [dashboardId], references: [id])
  dashboardId    String?
  order          Int              @default(0) // Order within folder for drag-and-drop
  starred        Boolean          @default(false)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  permissions    FilePermission[]
  trashedAt      DateTime?
  activities     Activity[]
  fileReferences FileReference[]

  @@index([userId])
  @@index([folderId])
  @@index([dashboardId])
  @@map("files")
}

model Folder {
  id          String             @id @default(uuid())
  user        User               @relation(fields: [userId], references: [id])
  userId      String
  name        String
  parent      Folder?            @relation("FolderParent", fields: [parentId], references: [id])
  parentId    String?
  dashboard   Dashboard?         @relation(fields: [dashboardId], references: [id])
  dashboardId String?
  order       Int                @default(0) // Order within parent folder for drag-and-drop
  starred     Boolean            @default(false)
  children    Folder[]           @relation("FolderParent")
  files       File[]
  permissions FolderPermission[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  trashedAt   DateTime?

  @@index([userId])
  @@index([parentId])
  @@index([dashboardId])
  @@map("folders")
}

model FilePermission {
  id        String   @id @default(uuid())
  file      File     @relation(fields: [fileId], references: [id])
  fileId    String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  canRead   Boolean  @default(true)
  canWrite  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([fileId, userId])
  @@index([fileId])
  @@index([userId])
  @@map("file_permissions")
}

model FolderPermission {
  id        String   @id @default(uuid())
  folder    Folder   @relation(fields: [folderId], references: [id])
  folderId  String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  canRead   Boolean  @default(true)
  canWrite  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([folderId, userId])
  @@index([folderId])
  @@index([userId])
  @@map("folder_permissions")
}

model Activity {
  id        String   @id @default(uuid())
  type      String // 'create', 'edit', 'delete', 'share', 'download'
  timestamp DateTime @default(now())
  details   Json? // Additional activity details
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  file      File     @relation(fields: [fileId], references: [id])
  fileId    String

  @@index([userId])
  @@index([fileId])
  @@index([timestamp])
  @@map("activities")
}

// ============================================================================
// ADMIN MODULE
// ============================================================================

// ============================================================================
// ADMIN PORTAL & SYSTEM MONITORING MODELS
// ============================================================================

// Content moderation
model ContentReport {
  id          String    @id @default(uuid())
  reporterId  String
  reporter    User      @relation("ContentReporter", fields: [reporterId], references: [id])
  contentId   String
  contentType String
  reason      String
  status      String    @default("pending")
  createdAt   DateTime  @default(now())
  reviewedBy  String?
  reviewedAt  DateTime?
  action      String?
  details     String?

  @@index([reporterId])
  @@index([contentType])
  @@index([status])
  @@map("content_reports")
}

// System monitoring and analytics
model SystemMetrics {
  id          String   @id @default(uuid())
  metricType  String
  metricName  String
  metricValue Float
  timestamp   DateTime @default(now())
  metadata    Json?

  @@index([metricType])
  @@index([metricName])
  @@index([timestamp])
  @@map("system_metrics")
}

// System configuration
model SystemConfig {
  id          String   @id @default(uuid())
  configKey   String   @unique
  configValue Json
  description String?
  updatedBy   String
  updatedAt   DateTime @default(now())

  @@index([configKey])
  @@map("system_configs")
}

// Security events
model SecurityEvent {
  id         String   @id @default(uuid())
  eventType  String
  userId     String?
  userEmail  String?
  adminId    String?
  adminEmail String?
  ipAddress  String?
  userAgent  String?
  details    Json?
  severity   String
  timestamp  DateTime @default(now())
  resolved   Boolean  @default(false)

  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@index([resolved])
  @@map("security_events")
}

// Admin impersonation sessions
model AdminImpersonation {
  id               String     @id @default(uuid())
  adminId          String
  admin            User       @relation("AdminImpersonator", fields: [adminId], references: [id])
  targetUserId     String
  targetUser       User       @relation("ImpersonatedUser", fields: [targetUserId], references: [id])
  businessId       String?
  business         Business?  @relation(fields: [businessId], references: [id], onDelete: SetNull)
  startedAt        DateTime   @default(now())
  endedAt          DateTime?
  reason           String?
  context          String? // Optional description of impersonation scope (e.g., module or purpose)
  sessionTokenHash String?    @unique // Hashed token shared with client to authenticate impersonated requests
  expiresAt        DateTime? // Optional expiration for impersonation session
  auditLogs        AuditLog[]

  @@index([adminId])
  @@index([targetUserId])
  @@index([startedAt])
  @@index([businessId])
  @@index([adminId, endedAt]) // Composite index for common query pattern: find active impersonations by admin
  @@map("admin_impersonations")
}

// Audit logging
model AuditLog {
  id                   String              @id @default(uuid())
  action               String // e.g., "MESSAGE_CREATED", "MESSAGE_DELETED", "USER_JOINED"
  userId               String
  user                 User                @relation(fields: [userId], references: [id])
  conversationId       String?
  resourceType         String? // e.g., "FILE", "CONVERSATION", "DASHBOARD", "MODULE"
  resourceId           String? // ID of the accessed resource
  details              String // JSON string with additional details
  timestamp            DateTime            @default(now())
  ipAddress            String?
  userAgent            String?
  adminImpersonationId String?
  adminImpersonation   AdminImpersonation? @relation(fields: [adminImpersonationId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([timestamp])
  @@index([conversationId])
  @@index([resourceType])
  @@index([resourceId])
  @@index([adminImpersonationId])
  @@map("audit_logs")
}

// Data Classification System
model DataClassification {
  id           String    @id @default(uuid())
  resourceType String // 'file', 'message', 'conversation', 'dashboard', 'module', etc.
  resourceId   String // ID of the classified resource
  sensitivity  String // 'PUBLIC', 'INTERNAL', 'CONFIDENTIAL', 'RESTRICTED'
  classifiedBy String // User ID who classified
  classifiedAt DateTime  @default(now())
  expiresAt    DateTime? // When classification expires
  notes        String? // Optional notes about classification
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([resourceType, resourceId])
  @@index([sensitivity])
  @@index([classifiedBy])
  @@index([expiresAt])
  @@map("data_classifications")
}

// Classification Rules for Automated Classification
model ClassificationRule {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  pattern      String // Regex pattern for matching content
  resourceType String // What type of resource this rule applies to
  sensitivity  String // Target sensitivity level
  priority     Int      @default(0) // Higher priority rules are applied first
  isActive     Boolean  @default(true)
  createdBy    String // User ID who created the rule
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([resourceType])
  @@index([isActive])
  @@index([priority])
  @@map("classification_rules")
}

// Classification Templates for Quick Classification
model ClassificationTemplate {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  sensitivity String // 'PUBLIC', 'INTERNAL', 'CONFIDENTIAL', 'RESTRICTED'
  expiresIn   Int? // Days until expiration (null = no expiration)
  notes       String? // Default notes for this template
  createdBy   String // User ID who created the template
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sensitivity])
  @@map("classification_templates")
}

// Enhanced Retention Policies (system-wide)
model SystemRetentionPolicy {
  id              String   @id @default(uuid())
  name            String   @unique
  description     String?
  resourceType    String // What type of data this applies to
  retentionPeriod Int // Days to retain
  archiveAfter    Int? // Days before archiving
  deleteAfter     Int? // Days before deletion
  isActive        Boolean  @default(true)
  createdBy       String // User ID who created the policy
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([resourceType])
  @@index([isActive])
  @@map("system_retention_policies")
}

// Backup Records
model BackupRecord {
  id         String   @id @default(uuid())
  backupType String // 'database', 'files', 'full', 'incremental'
  backupPath String // Path to backup file
  backupSize Int // Size in bytes
  checksum   String // Backup integrity checksum
  status     String // 'completed', 'failed', 'verifying', 'restoring'
  notes      String? // Optional notes about the backup
  createdAt  DateTime @default(now())
  expiresAt  DateTime // When backup should be deleted
  createdBy  String // User ID who initiated the backup

  @@index([backupType])
  @@index([status])
  @@index([expiresAt])
  @@map("backup_records")
}

// Data Governance Policies
model GovernancePolicy {
  id          String            @id @default(uuid())
  name        String            @unique
  description String?
  policyType  String // 'retention', 'classification', 'access', 'encryption'
  rules       Json // JSON object with policy rules
  isActive    Boolean           @default(true)
  createdBy   String // User ID who created the policy
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  violations  PolicyViolation[]

  @@index([policyType])
  @@index([isActive])
  @@map("governance_policies")
}

// Policy Violations
model PolicyViolation {
  id              String           @id @default(uuid())
  policy          GovernancePolicy @relation(fields: [policyId], references: [id])
  policyId        String
  resourceType    String // Type of resource that violated the policy
  resourceId      String // ID of the resource that violated the policy
  violationType   String // Type of violation (e.g., 'classification', 'retention', 'access')
  severity        String // 'low', 'medium', 'high', 'critical'
  message         String // Description of the violation
  detectedAt      DateTime         @default(now())
  resolvedAt      DateTime?
  resolvedBy      String? // User ID who resolved the violation
  resolutionNotes String? // Notes about how the violation was resolved
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([policyId])
  @@index([resourceType])
  @@index([severity])
  @@index([detectedAt])
  @@index([resolvedAt])
  @@map("policy_violations")
}

// ============================================================================
// ADMIN MODULE
// ============================================================================

// ============================================================================
// AI PROVIDER HISTORICAL TRACKING
// ============================================================================
// Stores daily snapshots of AI provider usage and expense data
// Enables trend analysis, historical reporting, and reduces API calls

model AIProviderUsageSnapshot {
  id           String   @id @default(uuid())
  provider     String // 'openai' | 'anthropic'
  snapshotDate DateTime // Date of the snapshot (YYYY-MM-DD)

  // Usage metrics
  totalTokens   BigInt @default(0)
  inputTokens   BigInt @default(0)
  outputTokens  BigInt @default(0)
  totalRequests Int    @default(0)

  // Cost metrics
  totalCost Decimal @default(0) @db.Decimal(10, 4)
  currency  String  @default("USD")

  // Model breakdown (stored as JSON for flexibility)
  modelBreakdown Json // [{ model: string, tokens: number, requests: number, cost: number }]

  // Time series data (hourly breakdown for the day)
  hourlyData Json? // [{ hour: number, tokens: number, requests: number, cost: number }]

  // Metadata
  syncedAt       DateTime @default(now())
  syncSource     String   @default("scheduled") // 'scheduled' | 'manual' | 'api'
  rawApiResponse Json? // Store raw API response for debugging

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, snapshotDate])
  @@index([provider])
  @@index([snapshotDate])
  @@index([provider, snapshotDate])
  @@map("ai_provider_usage_snapshots")
}

model AIProviderExpenseSnapshot {
  id          String   @id @default(uuid())
  provider    String // 'openai' | 'anthropic'
  period      String // 'day' | 'week' | 'month' | 'year'
  periodStart DateTime // Start of the period
  periodEnd   DateTime // End of the period

  // Expense metrics
  totalCost Decimal @default(0) @db.Decimal(10, 4)
  currency  String  @default("USD")

  // Breakdown by date (for periods > day)
  dailyBreakdown Json? // [{ date: string, cost: number, description: string }]

  // Model breakdown
  modelBreakdown Json? // [{ model: string, cost: number }]

  // Metadata
  syncedAt       DateTime @default(now())
  syncSource     String   @default("scheduled")
  rawApiResponse Json? // Store raw API response for debugging

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, period, periodStart])
  @@index([provider])
  @@index([period])
  @@index([periodStart])
  @@index([provider, period, periodStart])
  @@map("ai_provider_expense_snapshots")
}

// ============================================================================
// ADMIN MODULE
// ============================================================================

// Application Logging System
// Stores system and application logs for monitoring and debugging

model Log {
  id          String     @id @default(uuid())
  level       LogLevel   @default(info)
  message     String     @db.Text
  service     LogService
  operation   String?    @db.VarChar(255)
  userId      String?
  businessId  String?
  module      String?    @db.VarChar(100)
  metadata    Json?
  ipAddress   String?    @db.VarChar(50)
  userAgent   String?    @db.Text
  requestId   String?    @db.VarChar(100)
  duration    Int? // Request duration in milliseconds
  statusCode  Int? // HTTP status code
  errorStack  String?    @db.Text
  environment String     @default("production") @db.VarChar(50)
  timestamp   DateTime   @default(now())
  createdAt   DateTime   @default(now())

  // Indexes for common queries
  @@index([level, timestamp])
  @@index([service, timestamp])
  @@index([operation, timestamp])
  @@index([userId, timestamp])
  @@index([businessId, timestamp])
  @@index([module, timestamp])
  @@index([timestamp])
  @@map("logs")
}

model LogAlert {
  id            String    @id @default(uuid())
  name          String    @db.VarChar(255)
  description   String?   @db.Text
  conditions    Json // { level?: string[], operation?: string[], message?: string }
  actions       Json // { email?: string[], webhook?: string, threshold?: number }
  enabled       Boolean   @default(true)
  lastTriggered DateTime?
  triggerCount  Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("log_alerts")
}

model LogRetentionPolicy {
  id                   String    @id @default(uuid())
  defaultRetentionDays Int       @default(30)
  errorRetentionDays   Int       @default(90)
  auditRetentionDays   Int       @default(365)
  enabled              Boolean   @default(true)
  autoCleanup          Boolean   @default(true)
  lastCleanup          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@map("log_retention_policies")
}

enum LogLevel {
  debug
  info
  warn
  error
}

enum LogService {
  vssyl_server
  vssyl_web
}

// ============================================================================
// ADMIN MODULE
// ============================================================================

// ============================================================================
// SECURITY & COMPLIANCE MODELS
// ============================================================================

// SSO Integration
model SSOProvider {
  id        String   @id @default(uuid())
  name      String
  type      String // oauth2, saml, ldap, oidc
  config    Json // Provider configuration
  status    String // active, inactive, error
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions SSOSession[]

  @@index([type])
  @@index([status])
  @@map("sso_providers")
}

model SSOSession {
  id           String      @id @default(uuid())
  providerId   String
  provider     SSOProvider @relation(fields: [providerId], references: [id])
  userId       String
  sessionToken String      @unique
  expiresAt    DateTime
  metadata     Json? // Session metadata
  createdAt    DateTime    @default(now())

  @@index([providerId])
  @@index([userId])
  @@index([expiresAt])
  @@map("sso_sessions")
}

// Enterprise Security
model ComplianceFramework {
  id          String   @id @default(uuid())
  name        String // SOC 2, ISO 27001, GDPR, etc.
  version     String
  description String?
  status      String // active, inactive, deprecated
  controls    Json // Framework controls
  config      Json? // Framework configuration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([status])
  @@map("compliance_frameworks")
}

model SecurityIncident {
  id            String    @id @default(uuid())
  title         String
  description   String
  severity      String // low, medium, high, critical
  status        String // open, investigating, resolved, closed
  category      String // data_breach, unauthorized_access, etc.
  affectedUsers Int?
  data          Json // Incident details and evidence
  reportedAt    DateTime  @default(now())
  resolvedAt    DateTime?
  reportedBy    String?

  @@index([severity])
  @@index([status])
  @@index([category])
  @@index([reportedAt])
  @@map("security_incidents")
}

model SecurityAudit {
  id              String    @id @default(uuid())
  type            String // access, data, compliance, system
  scope           String // user, module, system, data
  findings        Json // Audit findings
  recommendations String[]
  status          String // pending, in_progress, completed
  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  auditor         String?

  @@index([type])
  @@index([scope])
  @@index([status])
  @@map("security_audits")
}

// ============================================================================
// ADMIN MODULE
// ============================================================================

// Support System Models
// This module handles customer support tickets, knowledge base, and live chat

model SupportTicket {
  id          String                @id @default(cuid())
  title       String
  description String                @db.Text
  status      SupportTicketStatus   @default(OPEN)
  priority    SupportTicketPriority @default(MEDIUM)
  category    String
  tags        String[] // Array of tags

  // Customer information
  customerId String
  customer   User   @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Assignment
  assignedToId String?
  assignedTo   User?   @relation("AssignedTickets", fields: [assignedToId], references: [id])

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?
  closedAt   DateTime?

  // Response tracking
  responseTime   Float? // in hours
  resolutionTime Float? // in hours
  satisfaction   Int? // 1-5 rating

  // Attachments
  attachments SupportAttachment[]

  // Messages/Responses
  messages SupportMessage[]

  // Analytics
  views        Int       @default(0)
  lastViewedAt DateTime?

  @@map("support_tickets")
}

model SupportMessage {
  id       String        @id @default(cuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Message details
  content        String  @db.Text
  isInternal     Boolean @default(false) // Internal notes vs customer-visible
  isFromCustomer Boolean @default(true)

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Attachments
  attachments SupportAttachment[]

  @@map("support_messages")
}

model SupportAttachment {
  id           String @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int // in bytes
  path         String // file path

  // Relations
  ticketId String?
  ticket   SupportTicket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  messageId String?
  message   SupportMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@map("support_attachments")
}

model KnowledgeBaseArticle {
  id       String   @id @default(cuid())
  title    String
  content  String   @db.Text
  excerpt  String?  @db.Text
  category String
  tags     String[]

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Status
  status KnowledgeBaseStatus @default(DRAFT)

  // Analytics
  views      Int @default(0)
  helpful    Int @default(0)
  notHelpful Int @default(0)

  // SEO
  slug            String  @unique
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@map("knowledge_base_articles")
}

model LiveChatSession {
  id String @id @default(cuid())

  // Customer
  customerId String
  customer   User   @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Agent assignment
  agentId String?
  agent   User?   @relation("LiveChatSessions", fields: [agentId], references: [id])

  // Session details
  status  LiveChatStatus @default(WAITING)
  subject String?
  notes   String?        @db.Text

  // Timestamps
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  lastMessageAt DateTime  @default(now())

  // Analytics
  messageCount Int  @default(0)
  duration     Int? // in minutes
  satisfaction Int? // 1-5 rating

  // Messages
  messages LiveChatMessage[]

  @@map("live_chat_sessions")
}

model LiveChatMessage {
  id        String          @id @default(cuid())
  sessionId String
  session   LiveChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Message details
  content        String  @db.Text
  isFromCustomer Boolean @default(true)

  // Author
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())

  @@map("live_chat_messages")
}

model SupportAnalytics {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  // Ticket metrics
  ticketsCreated  Int @default(0)
  ticketsResolved Int @default(0)
  ticketsClosed   Int @default(0)

  // Response metrics
  avgResponseTime   Float? // in hours
  avgResolutionTime Float? // in hours

  // Satisfaction
  avgSatisfaction   Float? // 1-5 rating
  satisfactionCount Int    @default(0)

  // Chat metrics
  chatSessions    Int    @default(0)
  avgChatDuration Float? // in minutes

  // Knowledge base
  articleViews   Int @default(0)
  articleHelpful Int @default(0)

  @@unique([date])
  @@map("support_analytics")
}

// Enums
enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum KnowledgeBaseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LiveChatStatus {
  WAITING
  ACTIVE
  ENDED
}

// ============================================================================
// HR MODULE
// ============================================================================

// ============================================================================
// HR ATTENDANCE & TIME-OFF
// ============================================================================

model TimeOffRequest {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessTimeOffRequests", fields: [businessId], references: [id], onDelete: Cascade)

  employeePositionId String
  employeePosition   EmployeePosition @relation("EmployeePositionTimeOffRequests", fields: [employeePositionId], references: [id], onDelete: Cascade)

  type      TimeOffType
  startDate DateTime
  endDate   DateTime
  reason    String?

  status          TimeOffStatus @default(PENDING)
  requestedById   String
  requestedAt     DateTime      @default(now())
  approvedById    String?
  approvedAt      DateTime?
  managerNote     String?
  scheduleEventId String?
  personalEventId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([employeePositionId])
  @@index([status])
  @@map("time_off_requests")
}

enum TimeOffType {
  PTO
  SICK
  PERSONAL
  UNPAID
}

enum TimeOffStatus {
  PENDING
  APPROVED
  DENIED
  CANCELED
}

// ============================================================================
// ATTENDANCE POLICIES & CONFIGURATION
// ============================================================================

model AttendancePolicy {
  id                       String    @id @default(uuid())
  businessId               String
  business                 Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name                     String
  description              String?
  timezone                 String?
  roundingIncrementMinutes Int?
  gracePeriodMinutes       Int?
  autoClockOutAfterMinutes Int?
  requireGeolocation       Boolean   @default(false)
  geofenceRadiusMeters     Int?
  workingDays              String[]  @default([])
  metadata                 Json?
  isDefault                Boolean   @default(false)
  effectiveFrom            DateTime?
  effectiveTo              DateTime?
  active                   Boolean   @default(true)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  shiftTemplates       AttendanceShiftTemplate[]
  attendanceRecords    AttendanceRecord[]        @relation("PolicyAttendanceRecords")
  attendanceExceptions AttendanceException[]     @relation("PolicyAttendanceExceptions")

  @@index([businessId])
  @@index([active])
  @@map("attendance_policies")
}

model AttendanceShiftTemplate {
  id           String            @id @default(uuid())
  businessId   String
  business     Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name         String
  description  String?
  timezone     String?
  startMinutes Int // Minutes from midnight local time
  endMinutes   Int
  breakMinutes Int?
  daysOfWeek   String[]          @default([])
  policyId     String?
  policy       AttendancePolicy? @relation(fields: [policyId], references: [id], onDelete: SetNull)
  metadata     Json?
  isActive     Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  assignments AttendanceShiftAssignment[]

  @@unique([businessId, name])
  @@index([businessId])
  @@index([policyId])
  @@index([isActive])
  @@map("attendance_shift_templates")
}

model AttendanceShiftAssignment {
  id                 String                          @id @default(uuid())
  businessId         String
  business           Business                        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  shiftTemplateId    String
  shiftTemplate      AttendanceShiftTemplate         @relation(fields: [shiftTemplateId], references: [id], onDelete: Cascade)
  employeePositionId String
  employeePosition   EmployeePosition                @relation("EmployeeAttendanceAssignments", fields: [employeePositionId], references: [id], onDelete: Cascade)
  effectiveFrom      DateTime
  effectiveTo        DateTime?
  status             AttendanceShiftAssignmentStatus @default(ACTIVE)
  isPrimary          Boolean                         @default(true)
  overrides          Json?
  createdAt          DateTime                        @default(now())
  updatedAt          DateTime                        @updatedAt

  attendanceRecords AttendanceRecord[] @relation("ShiftAttendanceRecords")

  @@unique([employeePositionId, shiftTemplateId, effectiveFrom])
  @@index([businessId])
  @@index([employeePositionId])
  @@index([shiftTemplateId])
  @@index([status])
  @@map("attendance_shift_assignments")
}

model AttendanceRecord {
  id                 String                     @id @default(uuid())
  businessId         String
  business           Business                   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  employeePositionId String
  employeePosition   EmployeePosition           @relation("EmployeeAttendanceRecords", fields: [employeePositionId], references: [id], onDelete: Cascade)
  shiftAssignmentId  String?
  shiftAssignment    AttendanceShiftAssignment? @relation("ShiftAttendanceRecords", fields: [shiftAssignmentId], references: [id], onDelete: SetNull)
  policyId           String?
  policy             AttendancePolicy?          @relation("PolicyAttendanceRecords", fields: [policyId], references: [id], onDelete: SetNull)
  workDate           DateTime
  clockInTime        DateTime?
  clockInMethod      AttendanceMethod?
  clockInLocation    Json?
  clockInSource      String?
  clockOutTime       DateTime?
  clockOutMethod     AttendanceMethod?
  clockOutLocation   Json?
  clockOutSource     String?
  status             AttendanceRecordStatus     @default(IN_PROGRESS)
  durationMinutes    Int?
  varianceMinutes    Int?
  metadata           Json?
  exceptionFlagged   Boolean                    @default(false)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt

  exceptions AttendanceException[] @relation("RecordAttendanceExceptions")

  @@index([businessId, workDate])
  @@index([employeePositionId, workDate])
  @@index([status])
  @@map("attendance_records")
}

model AttendanceException {
  id                 String                    @id @default(uuid())
  businessId         String
  business           Business                  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  attendanceRecordId String?
  attendanceRecord   AttendanceRecord?         @relation("RecordAttendanceExceptions", fields: [attendanceRecordId], references: [id], onDelete: SetNull)
  employeePositionId String
  employeePosition   EmployeePosition          @relation("EmployeeAttendanceExceptions", fields: [employeePositionId], references: [id], onDelete: Cascade)
  policyId           String?
  policy             AttendancePolicy?         @relation("PolicyAttendanceExceptions", fields: [policyId], references: [id], onDelete: SetNull)
  type               AttendanceExceptionType
  status             AttendanceExceptionStatus @default(OPEN)
  detectedAt         DateTime                  @default(now())
  detectedById       String?
  detectedBy         User?                     @relation("AttendanceExceptionDetectedBy", fields: [detectedById], references: [id], onDelete: SetNull)
  detectedSource     String?
  details            Json?
  managerNote        String?
  resolutionNote     String?
  resolvedById       String?
  resolvedBy         User?                     @relation("AttendanceExceptionResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)
  resolvedAt         DateTime?
  resolutionPayload  Json?
  metadata           Json?
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt

  @@index([businessId, status])
  @@index([employeePositionId])
  @@index([attendanceRecordId])
  @@map("attendance_exceptions")
}

// ============================================================================
// ENUMERATIONS
// ============================================================================

enum AttendanceShiftAssignmentStatus {
  ACTIVE
  SUSPENDED
  ENDED
}

enum AttendanceRecordStatus {
  IN_PROGRESS
  COMPLETED
  MISSED
  VOID
}

enum AttendanceMethod {
  WEB
  MOBILE
  ADMIN
  AUTO
  HARDWARE
}

enum AttendanceExceptionType {
  MISSED_PUNCH
  LATE_ARRIVAL
  EARLY_DEPARTURE
  ABSENCE
  GEO_VIOLATION
  POLICY_OVERRIDE
  OTHER
}

enum AttendanceExceptionStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

// ============================================================================
// HR MODULE
// ============================================================================

// ============================================================================
// HR MODULE - CORE FRAMEWORK
// ============================================================================
// Purpose: Foundational HR data models that extend the org chart system
// Status: Framework only - features will be added incrementally
// Tier: Business Advanced (limited) + Enterprise (full)
// ============================================================================

// Core employee HR profile (extends org chart EmployeePosition)
model EmployeeHRProfile {
  id String @id @default(uuid())

  // ============================================================================
  // ORG CHART INTEGRATION (REQUIRED)
  // ============================================================================
  // Links to existing EmployeePosition in org chart system
  employeePositionId String           @unique
  employeePosition   EmployeePosition @relation(fields: [employeePositionId], references: [id], onDelete: Cascade)

  // ============================================================================
  // MULTI-TENANT ISOLATION (CRITICAL FOR SECURITY)
  // ============================================================================
  // All HR data MUST be scoped to a business to prevent data leakage
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // ============================================================================
  // CORE HR DATA (Framework - minimal fields for now)
  // ============================================================================
  hireDate          DateTime?
  terminationDate   DateTime?
  employmentStatus  EmploymentStatus @default(ACTIVE)
  terminationReason String?
  terminatedBy      String?
  terminationNotes  Json?
  employeeType      EmployeeType? // Full-time, Part-time, Contract, etc.
  workLocation      String? // Office, Remote, Hybrid

  // Emergency contact (stored as JSON for flexibility)
  emergencyContact Json? // { name, relationship, phone, email }

  // Personal information (sensitive - encrypted in production)
  personalInfo Json? // { birthday, address, etc. }

  // ============================================================================
  // SOFT DELETE (HR data must be retained for legal/audit)
  // ============================================================================
  deletedAt     DateTime?
  deletedBy     String?
  deletedReason String? // Termination, Resignation, etc.

  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================================================
  // FUTURE FEATURE RELATIONSHIPS (Prepared but not implemented)
  // ============================================================================
  // When we add features, uncomment these:
  // attendanceRecords  AttendanceRecord[]
  // payrollRecords     PayrollRecord[]
  // performanceReviews PerformanceReview[]
  // benefitEnrollments BenefitEnrollment[]
  // timeOffRequests    TimeOffRequest[]
  onboardingJourneys EmployeeOnboardingJourney[]

  // ============================================================================
  // INDEXES (Performance optimization)
  // ============================================================================
  @@index([businessId])
  @@index([employeePositionId])
  @@index([deletedAt])
  @@index([employeeType])
  @@index([employmentStatus])
  @@map("employee_hr_profiles")
}

// Employee type enumeration
enum EmployeeType {
  FULL_TIME // Full-time employee
  PART_TIME // Part-time employee
  CONTRACT // Contract worker
  INTERN // Intern
  TEMPORARY // Temporary worker
  SEASONAL // Seasonal worker
}

// Employment lifecycle status
enum EmploymentStatus {
  ACTIVE
  TERMINATED
  LEAVE
  SABBATICAL
}

// ============================================================================
// MANAGER APPROVAL HIERARCHY
// ============================================================================
// Defines who can approve what for each employee (time-off, expenses, etc.)
// This extends the org chart "reports to" relationship with approval-specific rules
model ManagerApprovalHierarchy {
  id String @id @default(uuid())

  // ============================================================================
  // EMPLOYEE & MANAGER RELATIONSHIP
  // ============================================================================
  // Employee who needs approvals
  employeePositionId String
  employeePosition   EmployeePosition @relation("EmployeeApprovals", fields: [employeePositionId], references: [id], onDelete: Cascade)

  // Manager who can approve
  managerPositionId String
  managerPosition   EmployeePosition @relation("ManagerApprovals", fields: [managerPositionId], references: [id], onDelete: Cascade)

  // ============================================================================
  // MULTI-TENANT ISOLATION
  // ============================================================================
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // ============================================================================
  // APPROVAL CONFIGURATION
  // ============================================================================
  // What types of approvals this manager can handle
  // Examples: ['time-off', 'expenses', 'performance-review', 'equipment']
  approvalTypes String[]

  // Priority level (1 = direct manager, 2 = skip-level, etc.)
  // Used for escalation: if manager doesn't approve in X days, escalate to level 2
  approvalLevel Int @default(1)

  // Is this the primary approver or a backup?
  isPrimary Boolean @default(true)

  // Active status (can be temporarily disabled)
  active Boolean @default(true)

  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================================================
  // CONSTRAINTS & INDEXES
  // ============================================================================
  // Ensure unique combination of employee + manager + business
  @@unique([employeePositionId, managerPositionId, businessId])
  @@index([businessId])
  @@index([employeePositionId])
  @@index([managerPositionId])
  @@index([active])
  @@map("manager_approval_hierarchy")
}

// ============================================================================
// HR MODULE SETTINGS (Business-level configuration)
// ============================================================================
// Global HR settings for each business (policies, defaults, etc.)
model HRModuleSettings {
  id String @id @default(uuid())

  // ============================================================================
  // MULTI-TENANT ISOLATION
  // ============================================================================
  businessId String   @unique // One settings record per business
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // ============================================================================
  // GENERAL SETTINGS (Framework - will be expanded)
  // ============================================================================
  // Time-off policies
  timeOffSettings    Json? // { defaultPTODays, accrualRules, carryoverPolicy, etc. }
  // Calendar integration
  scheduleCalendarId String?

  // Work week configuration
  workWeekSettings Json? // { daysPerWeek, hoursPerDay, startDayOfWeek, etc. }

  // Payroll settings (Enterprise only)
  payrollSettings Json? // { payPeriod, directDepositDefault, etc. }

  // Feature toggles (which HR features are enabled)
  enabledFeatures Json? // { employees: true, attendance: true, payroll: false, etc. }

  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@map("hr_module_settings")
}

// ============================================================================
// NOTES FOR FUTURE FEATURE DEVELOPMENT
// ============================================================================
// When adding new HR features (attendance, payroll, etc.), create separate
// .prisma files in this directory:
// - attendance.prisma (time-off, clock in/out, schedules)
// - payroll.prisma (pay runs, pay stubs, tax calculations)
// - recruitment.prisma (job postings, applications, interviews)
// - performance.prisma (reviews, goals, feedback)
// - benefits.prisma (plans, enrollments, COBRA)
//
// Each feature file should follow the same patterns:
// 1. Multi-tenant isolation (businessId on all tables)
// 2. Soft deletes where appropriate
// 3. Proper indexing for performance
// 4. Reference EmployeeHRProfile (not directly to User)
// ============================================================================

// ============================================================================
// HR MODULE
// ============================================================================

// ============================================================================
// HR MODULE - EMPLOYEE ONBOARDING
// ============================================================================
// Purpose: Structured onboarding journeys, templates, and task tracking
// Status: Planning  Phase 1 (data layer scaffolding)
// Tier: Business Advanced (core) + Enterprise (automation, analytics)
// ============================================================================

// ============================================================================
// ONBOARDING TEMPLATE DEFINITIONS (Business-level configuration)
// ============================================================================
model OnboardingTemplate {
  id String @id @default(uuid())

  // BUSINESS SCOPING (multi-tenant isolation)
  businessId String
  business   Business @relation("BusinessOnboardingTemplates", fields: [businessId], references: [id], onDelete: Cascade)

  // TEMPLATE METADATA
  name        String
  description String?
  isDefault   Boolean @default(false)
  isActive    Boolean @default(true)
  ownerUserId String? // Optional: specific user who owns/maintains this template

  // APPLICABILITY & AUTOMATION (stored as JSON for flexibility)
  // Example: { roles: ['manager'], departments: ['sales'], locations: ['NY'], employmentTypes: ['FULL_TIME'] }
  applicabilityRules Json?

  // Automation/advanced configuration (Enterprise only)
  automationSettings Json? // { autoStartOnHire: true, autoAssignBuddy: true, calendarSync: true }

  // RELATIONSHIPS
  taskTemplates              OnboardingTaskTemplate[]
  employeeOnboardingJourneys EmployeeOnboardingJourney[]

  // SOFT DELETE / ARCHIVE
  archivedAt DateTime?
  archivedBy String?

  // TIMESTAMPS
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([isActive])
  @@index([isDefault])
  @@map("hr_onboarding_templates")
}

// ============================================================================
// ONBOARDING TASK TEMPLATE (Reusable task definitions)
// ============================================================================
model OnboardingTaskTemplate {
  id String @id @default(uuid())

  // RELATIONS & SCOPING
  onboardingTemplateId String
  onboardingTemplate   OnboardingTemplate @relation(fields: [onboardingTemplateId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation("BusinessOnboardingTaskTemplates", fields: [businessId], references: [id], onDelete: Cascade)

  // TASK DETAILS
  title       String
  description String?
  orderIndex  Int     @default(0) // Controls ordering within the template

  taskType       OnboardingTaskType      @default(CUSTOM)
  ownerType      OnboardingTaskOwnerType @default(EMPLOYEE)
  ownerReference String? // Optional: position/role/user reference

  // Due date offset relative to journey start (in days)
  dueOffsetDays Int? // e.g., -1 = day before start, 0 = start day, 5 = five days after start

  requiresApproval Boolean @default(false)
  requiresDocument Boolean @default(false)

  // Additional metadata (e.g., document templates, equipment SKUs, training course IDs)
  metadata Json?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  taskInstances EmployeeOnboardingTask[] @relation("TaskTemplateTasks")

  @@index([businessId])
  @@index([onboardingTemplateId])
  @@index([taskType])
  @@index([ownerType])
  @@map("hr_onboarding_task_templates")
}

// ============================================================================
// EMPLOYEE ONBOARDING JOURNEY (Live instance per employee)
// ============================================================================
model EmployeeOnboardingJourney {
  id String @id @default(uuid())

  // RELATIONSHIPS
  businessId String
  business   Business @relation("BusinessEmployeeOnboardingJourneys", fields: [businessId], references: [id], onDelete: Cascade)

  employeeHrProfileId String
  employeeHrProfile   EmployeeHRProfile @relation(fields: [employeeHrProfileId], references: [id], onDelete: Cascade)

  onboardingTemplateId String?
  onboardingTemplate   OnboardingTemplate? @relation(fields: [onboardingTemplateId], references: [id])

  // JOURNEY STATUS
  status          OnboardingJourneyStatus @default(IN_PROGRESS)
  startDate       DateTime
  completionDate  DateTime?
  cancelledAt     DateTime?
  cancelledReason String?

  // JOURNEY METADATA
  // Example: { department: 'Engineering', jobLevel: 'L3', buddyId: '...', notes: '...' }
  metadata Json?

  // RELATIONSHIPS
  tasks EmployeeOnboardingTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([employeeHrProfileId])
  @@index([status])
  @@map("hr_employee_onboarding_journeys")
}

// ============================================================================
// EMPLOYEE ONBOARDING TASK (Concrete task instance)
// ============================================================================
model EmployeeOnboardingTask {
  id String @id @default(uuid())

  // RELATIONSHIPS & SCOPING
  onboardingJourneyId String
  onboardingJourney   EmployeeOnboardingJourney @relation(fields: [onboardingJourneyId], references: [id], onDelete: Cascade)

  businessId String
  business   Business @relation("BusinessEmployeeOnboardingTasks", fields: [businessId], references: [id], onDelete: Cascade)

  onboardingTaskTemplateId String?
  onboardingTaskTemplate   OnboardingTaskTemplate? @relation("TaskTemplateTasks", fields: [onboardingTaskTemplateId], references: [id])

  // TASK DETAILS
  title          String
  description    String?
  taskType       OnboardingTaskType      @default(CUSTOM)
  ownerType      OnboardingTaskOwnerType @default(EMPLOYEE)
  ownerReference String?

  assignedToUserId String? // Convenience reference for notifications/approvals
  dueDate          DateTime?

  status            OnboardingTaskStatus @default(PENDING)
  startedAt         DateTime?
  completedAt       DateTime?
  completedByUserId String?

  requiresApproval Boolean   @default(false)
  approvedAt       DateTime?
  approvedByUserId String?

  notes    String?
  metadata Json?

  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([onboardingJourneyId])
  @@index([status])
  @@index([taskType])
  @@index([ownerType])
  @@map("hr_employee_onboarding_tasks")
}

// ============================================================================
// ENUMERATIONS
// ============================================================================
enum OnboardingTaskType {
  DOCUMENT // Provide/read/acknowledge documents
  EQUIPMENT // Equipment or uniform distribution/setup
  TRAINING // Training module or certification
  MEETING // Scheduled meeting or introduction
  FORM // Fill out internal/external forms
  CUSTOM // Custom/general task
}

enum OnboardingTaskOwnerType {
  EMPLOYEE // Task assigned to the new employee
  MANAGER // Direct manager
  HR // HR representative
  BUDDY // Assigned buddy/mentor
  IT // IT/support staff
  OTHER // Other actor (specify in metadata/ownerReference)
}

enum OnboardingJourneyStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OnboardingTaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

// ============================================================================
// SCHEDULING MODULE
// ============================================================================

// ============================================================================
// SCHEDULING MODULE - CORE MODELS
// ============================================================================
// Purpose: Employee shift scheduling and workforce planning
// Separation: This handles PLANNING (future), HR handles TRACKING (past)
// ============================================================================

// ============================================================================
// SCHEDULES
// ============================================================================

model Schedule {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessSchedules", fields: [businessId], references: [id], onDelete: Cascade)

  name        String
  description String?
  locationId  String? // Job location (physical work site)
  location    JobLocation? @relation("ScheduleJobLocations", fields: [locationId], references: [id], onDelete: SetNull)

  startDate DateTime
  endDate   DateTime
  timezone  String   @default("America/New_York")

  status        ScheduleStatus @default(DRAFT)
  publishedAt   DateTime?
  publishedById String?
  publishedBy   User?          @relation("SchedulePublishedBy", fields: [publishedById], references: [id], onDelete: SetNull)

  templateId String? // Reference if created from template

  // Visual Builder Configuration
  layoutMode String? // 'employee' | 'role' | 'station'
  viewMode   String? // 'week' | 'day' | 'month' | 'coverage'

  metadata Json? // Additional schedule-level data
  // { 
  //   specialNotes: string,        // Week-level notes (holidays, events, etc.)
  //   holidays: string[],          // Holiday dates in ISO format
  //   events: Array<{ date: string, name: string, description?: string }>
  // }

  createdById String
  createdBy   User     @relation("ScheduleCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shifts ScheduleShift[]

  @@index([businessId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([layoutMode])
  @@map("schedules")
}

enum ScheduleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// ============================================================================
// SCHEDULE SHIFTS
// ============================================================================

model ScheduleShift {
  id         String   @id @default(uuid())
  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  businessId String
  business   Business @relation("BusinessScheduleShifts", fields: [businessId], references: [id], onDelete: Cascade)

  // Assignment
  employeePositionId String? // null = open shift
  employeePosition   EmployeePosition? @relation("EmployeeScheduleShifts", fields: [employeePositionId], references: [id], onDelete: Cascade)

  // Shift Details
  title        String
  startTime    DateTime
  endTime      DateTime
  breakMinutes Int?

  // Organization
  locationId   String? // Job location (physical work site)
  location     JobLocation? @relation("ShiftJobLocations", fields: [locationId], references: [id], onDelete: SetNull)
  departmentId String?
  positionId   String? // Required position for this shift
  position     Position?    @relation(fields: [positionId], references: [id], onDelete: SetNull)

  // Station/Job Function Assignment
  stationName String? // Specific station assignment ("Grill 1", "Server 1-10")
  jobFunction String? // Job function for this shift (from JobFunction enum)

  // Shift Properties
  notes            String?
  color            String? // Hex color for visual display
  isOpenShift      Boolean @default(false)
  requiresApproval Boolean @default(false)
  minStaffing      Int? // Minimum required staff
  maxStaffing      Int? // Maximum allowed staff
  priority         Int? // Scheduling priority (1-10, higher = fill first)

  // Template Reference
  shiftTemplateId String?
  shiftTemplate   ShiftTemplate? @relation(fields: [shiftTemplateId], references: [id], onDelete: SetNull)

  status   ShiftStatus @default(SCHEDULED)
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  swapRequests ShiftSwapRequest[] @relation("OriginalShift")

  @@index([scheduleId])
  @@index([businessId])
  @@index([employeePositionId])
  @@index([positionId])
  @@index([locationId])
  @@index([startTime, endTime])
  @@index([isOpenShift])
  @@index([stationName])
  @@index([jobFunction])
  @@index([priority])
  @@map("schedule_shifts")
}

enum ShiftStatus {
  SCHEDULED
  OPEN
  FILLED
  CANCELLED
  COMPLETED
}

// ============================================================================
// SHIFT TEMPLATES
// ============================================================================

model ShiftTemplate {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessShiftTemplates", fields: [businessId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Default times (time-only, no date)
  defaultStartTime    String // "08:00"
  defaultEndTime      String // "16:00"
  defaultBreakMinutes Int?

  // Recurrence
  daysOfWeek String[] @default([]) // ["MON", "TUE", "WED"]

  // Organization
  departmentId String?
  positionId   String?
  position     Position? @relation(fields: [positionId], references: [id], onDelete: SetNull)

  // Display
  color String?

  metadata Json?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scheduleShifts ScheduleShift[]

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
  @@map("shift_templates")
}

// ============================================================================
// EMPLOYEE AVAILABILITY
// ============================================================================

model EmployeeAvailability {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessEmployeeAvailability", fields: [businessId], references: [id], onDelete: Cascade)

  employeePositionId String
  employeePosition   EmployeePosition @relation("EmployeeAvailability", fields: [employeePositionId], references: [id], onDelete: Cascade)

  // Availability Details
  dayOfWeek        String // "MONDAY", "TUESDAY", etc.
  startTime        String // "08:00"
  endTime          String // "17:00"
  availabilityType AvailabilityType @default(AVAILABLE)

  // Effective Dates
  effectiveFrom DateTime
  effectiveTo   DateTime?
  recurring     Boolean   @default(true)

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([employeePositionId])
  @@index([dayOfWeek])
  @@map("employee_availability")
}

enum AvailabilityType {
  AVAILABLE
  UNAVAILABLE
  PREFERRED
}

// ============================================================================
// SHIFT SWAP REQUESTS
// ============================================================================

model ShiftSwapRequest {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessShiftSwapRequests", fields: [businessId], references: [id], onDelete: Cascade)

  originalShiftId String
  originalShift   ScheduleShift @relation("OriginalShift", fields: [originalShiftId], references: [id], onDelete: Cascade)

  requestedById String
  requestedBy   User   @relation("SwapRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)

  requestedToId String? // Specific employee (optional)
  requestedTo   User?   @relation("SwapRequestedTo", fields: [requestedToId], references: [id], onDelete: SetNull)

  reason String?

  status       SwapStatus @default(PENDING)
  approvedById String?
  approvedBy   User?      @relation("SwapApprovedBy", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt   DateTime?

  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([originalShiftId])
  @@index([requestedById])
  @@index([status])
  @@map("shift_swap_requests")
}

enum SwapStatus {
  PENDING
  APPROVED
  DENIED
  CANCELLED
  EXPIRED
}

// ============================================================================
// SCHEDULE TEMPLATES
// ============================================================================

model ScheduleTemplate {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessScheduleTemplates", fields: [businessId], references: [id], onDelete: Cascade)

  name        String
  description String?

  scheduleType String // "WEEKLY", "BIWEEKLY", "MONTHLY"
  templateData Json // Serialized schedule structure

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
  @@map("schedule_templates")
}

// ============================================================================
// BUSINESS STATIONS
// ============================================================================
// Business-level stations shared across all positions
// Used for station-based scheduling (e.g., "Grill 1", "Server 1-10", "ICU Nurse")

model BusinessStation {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessStations", fields: [businessId], references: [id], onDelete: Cascade)

  name        String // "Grill 1", "Server 1-10", "ICU Nurse", "Fry Station"
  stationType StationType // BOH, FOH, MANAGEMENT, HEALTHCARE, MANUFACTURING, OTHER
  jobFunction JobFunction? // Optional job function assignment (from Position model enum)
  description String?
  color       String? // Hex color for visual display

  isRequired       Boolean @default(false) // Must this station be covered daily?
  priority         Int? // Scheduling priority (1-10, higher = fill first)
  isActive         Boolean @default(true)
  defaultStartTime String? // Default HH:mm start time when scheduling this station
  defaultEndTime   String? // Default HH:mm end time when scheduling this station

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, name])
  @@index([businessId])
  @@index([stationType])
  @@index([jobFunction])
  @@index([isActive])
  @@map("business_stations")
}

// StationType enum is defined in org-chart.prisma (BOH, FOH, MANAGEMENT, HEALTHCARE, MANUFACTURING, OTHER)
// JobFunction enum is defined in org-chart.prisma (GRILL, FRY, SERVER, etc.)

// ============================================================================
// JOB LOCATIONS
// ============================================================================
// Physical work locations/sites where employees work
// Used for businesses that send employees to different sites (e.g., construction, service businesses)
// Separate from Stations (which are work roles/positions)

model JobLocation {
  id         String   @id @default(uuid())
  businessId String
  business   Business @relation("BusinessJobLocations", fields: [businessId], references: [id], onDelete: Cascade)

  name        String // "Downtown Office", "Construction Site A", "Warehouse 1", "Client Site - 123 Main St"
  address     Json? // Structured address data { street, city, state, zip, country }
  description String?
  phone       String? // Location-specific phone number
  email       String? // Location-specific email
  notes       String? // Additional location notes

  isActive Boolean @default(true)

  // Relations
  schedules      Schedule[]      @relation("ScheduleJobLocations")
  scheduleShifts ScheduleShift[] @relation("ShiftJobLocations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, name])
  @@index([businessId])
  @@index([isActive])
  @@map("job_locations")
}

// ============================================================================
// TODO MODULE
// ============================================================================

// ============================================================================
// TODO & TASK MANAGEMENT MODELS
// ============================================================================

model Task {
  id          String       @id @default(uuid())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)

  // Context & Scoping
  dashboardId String // Personal or business dashboard
  businessId  String? // Null for personal, set for business
  householdId String? // For household tasks

  // Ownership & Assignment
  createdById  String
  assignedToId String? // For business: assign to team member
  createdBy    User    @relation("TaskCreator", fields: [createdById], references: [id])
  assignedTo   User?   @relation("TaskAssignee", fields: [assignedToId], references: [id])

  // Dates & Scheduling
  dueDate      DateTime?
  startDate    DateTime?
  completedAt  DateTime?
  snoozedUntil DateTime? // For deferred tasks

  // Organization
  projectId    String? // Link to project (future)
  project      TaskProject? @relation(fields: [projectId], references: [id])
  parentTaskId String? // For subtasks
  parentTask   Task?        @relation("TaskSubtasks", fields: [parentTaskId], references: [id])
  subtasks     Task[]       @relation("TaskSubtasks")

  // Recurrence
  recurrenceRule        String? // RRULE format (like calendar events)
  recurrenceEndAt       DateTime?
  parentRecurringTaskId String?
  parentRecurringTask   Task?     @relation("TaskRecurrence", fields: [parentRecurringTaskId], references: [id])
  recurringInstances    Task[]    @relation("TaskRecurrence")

  // Metadata
  tags            String[]
  category        String? // Personal: "errands", "health", etc. Business: "project", "support", etc.
  timeEstimate    Int? // Estimated minutes
  actualTimeSpent Int? // Actual minutes (for analytics)

  // Dependencies
  dependsOnTasks TaskDependency[] @relation("TaskDependencies")
  blockingTasks  TaskDependency[] @relation("BlockingTasks")

  // Attachments & Links
  attachments  TaskAttachment[]
  linkedFiles  TaskFileLink[] // Links to Drive files
  linkedEvents TaskEventLink[] // Links to Calendar events

  // Collaboration (Business)
  comments TaskComment[]
  watchers TaskWatcher[] // Users watching this task
  timeLogs TaskTimeLog[] // Time tracking logs

  // Soft Delete
  trashedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dashboardId, businessId])
  @@index([assignedToId])
  @@index([status, dueDate])
  @@index([trashedAt])
  @@index([parentTaskId])
  @@index([createdById])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TaskDependency {
  id              String @id @default(uuid())
  task            Task   @relation("TaskDependencies", fields: [taskId], references: [id], onDelete: Cascade)
  taskId          String
  dependsOn       Task   @relation("BlockingTasks", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)
  dependsOnTaskId String

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId])
  @@index([dependsOnTaskId])
  @@map("task_dependencies")
}

model TaskAttachment {
  id       String  @id @default(uuid())
  task     Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId   String
  fileId   String? // Drive file ID
  url      String? // External URL
  name     String
  size     Int?
  mimeType String?

  @@index([taskId])
  @@map("task_attachments")
}

model TaskFileLink {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String
  fileId String // Drive file ID

  @@unique([taskId, fileId])
  @@index([taskId])
  @@index([fileId])
  @@map("task_file_links")
}

model TaskEventLink {
  id      String @id @default(uuid())
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId  String
  eventId String // Calendar event ID

  @@unique([taskId, eventId])
  @@index([taskId])
  @@index([eventId])
  @@map("task_event_links")
}

model TaskComment {
  id        String   @id @default(uuid())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([userId])
  @@map("task_comments")
}

model TaskWatcher {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
  @@map("task_watchers")
}

// Project grouping (future expansion)
model TaskProject {
  id          String   @id @default(uuid())
  name        String
  description String?
  dashboardId String
  businessId  String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks Task[]

  @@index([dashboardId, businessId])
  @@map("task_projects")
}

// Time tracking logs
model TaskTimeLog {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  startedAt   DateTime
  stoppedAt   DateTime?
  duration    Int? // Duration in minutes (calculated if stoppedAt is set)
  description String? // Optional note about what was done

  isActive Boolean @default(false) // True if timer is currently running

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([userId])
  @@index([isActive])
  @@index([startedAt])
  @@map("task_time_logs")
}
