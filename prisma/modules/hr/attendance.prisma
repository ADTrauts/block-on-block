// ============================================================================
// HR ATTENDANCE & TIME-OFF
// ============================================================================

model TimeOffRequest {
  id                 String   @id @default(uuid())
  businessId         String
  business           Business @relation("BusinessTimeOffRequests", fields: [businessId], references: [id], onDelete: Cascade)

  employeePositionId String
  employeePosition   EmployeePosition @relation("EmployeePositionTimeOffRequests", fields: [employeePositionId], references: [id], onDelete: Cascade)

  type               TimeOffType
  startDate          DateTime
  endDate            DateTime
  reason             String?

  status             TimeOffStatus @default(PENDING)
  requestedById      String
  requestedAt        DateTime @default(now())
  approvedById       String?
  approvedAt         DateTime?
  managerNote        String?
  scheduleEventId    String?
  personalEventId    String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([businessId])
  @@index([employeePositionId])
  @@index([status])
  @@map("time_off_requests")
}

enum TimeOffType {
  PTO
  SICK
  PERSONAL
  UNPAID
}

enum TimeOffStatus {
  PENDING
  APPROVED
  DENIED
  CANCELED
}

// ============================================================================
// ATTENDANCE POLICIES & CONFIGURATION
// ============================================================================

model AttendancePolicy {
  id                      String   @id @default(uuid())
  businessId              String
  business                Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name                    String
  description             String?
  timezone                String?
  roundingIncrementMinutes Int?
  gracePeriodMinutes      Int?
  autoClockOutAfterMinutes Int?
  requireGeolocation      Boolean  @default(false)
  geofenceRadiusMeters    Int?
  workingDays             String[] @default([])
  metadata                Json?
  isDefault               Boolean  @default(false)
  effectiveFrom           DateTime?
  effectiveTo             DateTime?
  active                  Boolean  @default(true)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  shiftTemplates          AttendanceShiftTemplate[]
  attendanceRecords       AttendanceRecord[]         @relation("PolicyAttendanceRecords")
  attendanceExceptions    AttendanceException[]      @relation("PolicyAttendanceExceptions")

  @@index([businessId])
  @@index([active])
  @@map("attendance_policies")
}

model AttendanceShiftTemplate {
  id                String   @id @default(uuid())
  businessId        String
  business          Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  name              String
  description       String?
  timezone          String?
  startMinutes      Int      // Minutes from midnight local time
  endMinutes        Int
  breakMinutes      Int?
  daysOfWeek        String[] @default([])
  policyId          String?
  policy            AttendancePolicy? @relation(fields: [policyId], references: [id], onDelete: SetNull)
  metadata          Json?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  assignments       AttendanceShiftAssignment[]

  @@unique([businessId, name])
  @@index([businessId])
  @@index([policyId])
  @@index([isActive])
  @@map("attendance_shift_templates")
}

model AttendanceShiftAssignment {
  id                  String   @id @default(uuid())
  businessId          String
  business            Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  shiftTemplateId     String
  shiftTemplate       AttendanceShiftTemplate @relation(fields: [shiftTemplateId], references: [id], onDelete: Cascade)
  employeePositionId  String
  employeePosition    EmployeePosition @relation("EmployeeAttendanceAssignments", fields: [employeePositionId], references: [id], onDelete: Cascade)
  effectiveFrom       DateTime
  effectiveTo         DateTime?
  status              AttendanceShiftAssignmentStatus @default(ACTIVE)
  isPrimary           Boolean  @default(true)
  overrides           Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  attendanceRecords   AttendanceRecord[] @relation("ShiftAttendanceRecords")

  @@unique([employeePositionId, shiftTemplateId, effectiveFrom])
  @@index([businessId])
  @@index([employeePositionId])
  @@index([shiftTemplateId])
  @@index([status])
  @@map("attendance_shift_assignments")
}

model AttendanceRecord {
  id                  String   @id @default(uuid())
  businessId          String
  business            Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  employeePositionId  String
  employeePosition    EmployeePosition @relation("EmployeeAttendanceRecords", fields: [employeePositionId], references: [id], onDelete: Cascade)
  shiftAssignmentId   String?
  shiftAssignment     AttendanceShiftAssignment? @relation("ShiftAttendanceRecords", fields: [shiftAssignmentId], references: [id], onDelete: SetNull)
  policyId            String?
  policy              AttendancePolicy? @relation("PolicyAttendanceRecords", fields: [policyId], references: [id], onDelete: SetNull)
  workDate            DateTime
  clockInTime         DateTime?
  clockInMethod       AttendanceMethod?
  clockInLocation     Json?
  clockInSource       String?
  clockOutTime        DateTime?
  clockOutMethod      AttendanceMethod?
  clockOutLocation    Json?
  clockOutSource      String?
  status              AttendanceRecordStatus @default(IN_PROGRESS)
  durationMinutes     Int?
  varianceMinutes     Int?
  metadata            Json?
  exceptionFlagged    Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  exceptions          AttendanceException[] @relation("RecordAttendanceExceptions")

  @@index([businessId, workDate])
  @@index([employeePositionId, workDate])
  @@index([status])
  @@map("attendance_records")
}

model AttendanceException {
  id                  String   @id @default(uuid())
  businessId          String
  business            Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  attendanceRecordId  String?
  attendanceRecord    AttendanceRecord? @relation("RecordAttendanceExceptions", fields: [attendanceRecordId], references: [id], onDelete: SetNull)
  employeePositionId  String
  employeePosition    EmployeePosition @relation("EmployeeAttendanceExceptions", fields: [employeePositionId], references: [id], onDelete: Cascade)
  policyId            String?
  policy              AttendancePolicy? @relation("PolicyAttendanceExceptions", fields: [policyId], references: [id], onDelete: SetNull)
  type                AttendanceExceptionType
  status              AttendanceExceptionStatus @default(OPEN)
  detectedAt          DateTime  @default(now())
  detectedById        String?
  detectedBy          User?     @relation("AttendanceExceptionDetectedBy", fields: [detectedById], references: [id], onDelete: SetNull)
  detectedSource      String?
  details             Json?
  managerNote         String?
  resolutionNote      String?
  resolvedById        String?
  resolvedBy          User?     @relation("AttendanceExceptionResolvedBy", fields: [resolvedById], references: [id], onDelete: SetNull)
  resolvedAt          DateTime?
  resolutionPayload   Json?
  metadata            Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([businessId, status])
  @@index([employeePositionId])
  @@index([attendanceRecordId])
  @@map("attendance_exceptions")
}

// ============================================================================
// ENUMERATIONS
// ============================================================================

enum AttendanceShiftAssignmentStatus {
  ACTIVE
  SUSPENDED
  ENDED
}

enum AttendanceRecordStatus {
  IN_PROGRESS
  COMPLETED
  MISSED
  VOID
}

enum AttendanceMethod {
  WEB
  MOBILE
  ADMIN
  AUTO
  HARDWARE
}

enum AttendanceExceptionType {
  MISSED_PUNCH
  LATE_ARRIVAL
  EARLY_DEPARTURE
  ABSENCE
  GEO_VIOLATION
  POLICY_OVERRIDE
  OTHER
}

enum AttendanceExceptionStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}


