// ============================================================================
// BILLING & SUBSCRIPTION MODELS
// ============================================================================

// Core tier subscriptions (Free, Pro, Business Basic/Advanced, Enterprise)
model Subscription {
  id              String   @id @default(uuid())
  userId          String
  businessId      String?
  tier            String   // 'free', 'pro', 'business_basic', 'business_advanced', 'enterprise'
  status          String   // 'active', 'cancelled', 'past_due', 'unpaid'
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd Boolean @default(false)
  stripeSubscriptionId String?
  stripeCustomerId    String?
  
  // Stripe integration fields
  lastSyncedAt     DateTime? // Last time synced from Stripe
  stripeMetadata   Json?   // Store additional Stripe subscription data
  
  // Business-specific fields
  employeeCount   Int?     // Total employees for business plans
  includedEmployees Int?   // Included employees (10 for business plans)
  additionalEmployeeCost Float? // Cost for additional employees
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relationships
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business        Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  moduleSubscriptions ModuleSubscription[]
  usageRecords    UsageRecord[]
  invoices        Invoice[]

  @@index([userId])
  @@index([businessId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

// Module-specific subscriptions (App Store model)
model ModuleSubscription {
  id              String   @id @default(uuid())
  userId          String
  businessId      String?
  moduleId        String
  coreSubscriptionId String?
  tier            String   // 'premium', 'enterprise'
  status          String   // 'active', 'cancelled', 'past_due'
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd Boolean @default(false)
  stripeSubscriptionId String?
  stripeCustomerId    String?
  amount          Float
  platformRevenue Float    @default(0) // For third-party modules
  developerRevenue Float   @default(0) // For third-party modules
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relationships
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business        Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  module          Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  coreSubscription Subscription? @relation(fields: [coreSubscriptionId], references: [id], onDelete: SetNull)
  usageRecords    UsageRecord[]
  invoices        Invoice[]
  
  @@index([userId])
  @@index([businessId])
  @@index([moduleId])
  @@index([status])
  @@map("module_subscriptions")
}

// Usage tracking for both core tiers and modules
model UsageRecord {
  id              String   @id @default(uuid())
  subscriptionId  String?
  moduleSubscriptionId String?
  userId          String
  businessId      String?
  metric          String   // 'api_calls', 'storage_gb', 'ai_requests', 'messages', 'files'
  quantity        Int
  cost            Float
  periodStart     DateTime
  periodEnd       DateTime
  createdAt       DateTime @default(now())
  
  // Relationships
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  moduleSubscription ModuleSubscription? @relation(fields: [moduleSubscriptionId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business        Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([moduleSubscriptionId])
  @@index([userId])
  @@index([metric])
  @@index([periodStart])
  @@map("usage_records")
}

// Invoice management
model Invoice {
  id              String   @id @default(uuid())
  subscriptionId  String?
  moduleSubscriptionId String?
  businessId      String?
  amount          Float
  currency        String   @default("USD")
  status          String   // 'draft', 'open', 'paid', 'void', 'uncollectible'
  stripeInvoiceId String?
  dueDate         DateTime?
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  
  // Stripe integration fields
  stripeChargeId  String?  // Stripe charge ID
  stripePaymentIntentId String? // Stripe payment intent ID
  stripeCustomerId String? // Stripe customer ID
  stripeFee        Float?  // Stripe processing fee
  stripeNetAmount  Float? // Net amount after Stripe fees
  refundAmount     Float? @default(0) // Total refunded amount
  refundCount      Int?   @default(0) // Number of refunds
  lastSyncedAt     DateTime? // Last time synced from Stripe
  
  // Additional Stripe metadata
  stripeMetadata   Json?   // Store additional Stripe data (payment method, disputes, etc.)
  
  // Relationships
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  moduleSubscription ModuleSubscription? @relation(fields: [moduleSubscriptionId], references: [id], onDelete: Cascade)
  business        Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String?
  refunds         Refund[]  // Related refunds

  @@index([subscriptionId])
  @@index([moduleSubscriptionId])
  @@index([businessId])
  @@index([status])
  @@index([stripeInvoiceId])
  @@index([stripeChargeId])
  @@map("invoices")
}

// Refund tracking
model Refund {
  id              String   @id @default(uuid())
  invoiceId       String
  amount          Float
  currency        String   @default("USD")
  reason          String?  // 'duplicate', 'fraudulent', 'requested_by_customer', etc.
  status          String   // 'pending', 'succeeded', 'failed', 'canceled'
  stripeRefundId  String?  @unique // Stripe refund ID
  stripeChargeId String?  // Original charge ID
  createdAt       DateTime @default(now())
  processedAt     DateTime?
  
  // Relationships
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  @@index([invoiceId])
  @@index([stripeRefundId])
  @@map("refunds")
}

// Developer revenue tracking for third-party modules
model DeveloperRevenue {
  id              String   @id @default(uuid())
  developerId     String
  moduleId        String
  periodStart     DateTime
  periodEnd       DateTime
  totalRevenue    Float
  platformRevenue Float
  developerRevenue Float
  payoutStatus    String   @default("pending") // 'pending', 'paid', 'failed'
  payoutDate      DateTime?
  createdAt       DateTime @default(now())
  
  // Apple-style revenue split tracking
  commissionRate  Float    // Actual commission rate used (0.15 or 0.30)
  commissionType  String   // 'standard', 'small_business', 'long_term'
  subscriptionAgeMonths Int // Age of subscription when revenue was calculated
  isFirstYear     Boolean  @default(true) // True if subscription is in first year
  
  // Relationships
  developer       User     @relation(fields: [developerId], references: [id], onDelete: Cascade)
  module          Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@index([developerId])
  @@index([moduleId])
  @@index([periodStart])
  @@index([commissionType])
  @@map("developer_revenue")
}
